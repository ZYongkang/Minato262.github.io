<!DOCTYPE html>



  


<html class="theme-next pisces use-motion" lang="zh-Hans">
<head><meta name="generator" content="Hexo 3.8.0">
  <meta charset="UTF-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
<meta name="theme-color" content="#222">









<meta http-equiv="Cache-Control" content="no-transform">
<meta http-equiv="Cache-Control" content="no-siteapp">















  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css">




  
  
  
  

  
    
    
  

  

  

  

  

  
    
    
    <link href="//fonts.googleapis.com/css?family=Lato:300,300italic,400,400italic,700,700italic&subset=latin,latin-ext" rel="stylesheet" type="text/css">
  






<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css">

<link href="/css/main.css?v=5.1.2" rel="stylesheet" type="text/css">


  <meta name="keywords" content="Hexo, NexT">








  <link rel="shortcut icon" type="image/x-icon" href="/favicon.ico?v=5.1.2">






<meta name="description" content="第十九章 类型信息 RTTI（RunTime Type Information，运行时类型信息）能够在程序运行时发现和使用类型信息  RTTI 把我们从只能在编译期进行面向类型操作的禁锢中解脱了出来，并且让我们可以使用某些非常强大的程序。对 RTTI 的需要，揭示了面向对象设计中许多有趣（并且复杂）的特性，同时也带来了关于如何组织程序的基本问题。 本章将讨论 Java 是如何在运行时识别对象和类">
<meta property="og:type" content="article">
<meta property="og:title" content="第十九章 类型信息">
<meta property="og:url" content="http://yoursite.com/2019/07/01/3/3_book/OnJava8/19-Type-Information/index.html">
<meta property="og:site_name" content="水门的博客">
<meta property="og:description" content="第十九章 类型信息 RTTI（RunTime Type Information，运行时类型信息）能够在程序运行时发现和使用类型信息  RTTI 把我们从只能在编译期进行面向类型操作的禁锢中解脱了出来，并且让我们可以使用某些非常强大的程序。对 RTTI 的需要，揭示了面向对象设计中许多有趣（并且复杂）的特性，同时也带来了关于如何组织程序的基本问题。 本章将讨论 Java 是如何在运行时识别对象和类">
<meta property="og:locale" content="zh-Hans">
<meta property="og:image" content="http://yoursite.com/2019/07/01/3/3_book/OnJava8/images/image-20190409114913825-4781754.png">
<meta property="og:updated_time" content="2020-03-21T10:13:31.703Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="第十九章 类型信息">
<meta name="twitter:description" content="第十九章 类型信息 RTTI（RunTime Type Information，运行时类型信息）能够在程序运行时发现和使用类型信息  RTTI 把我们从只能在编译期进行面向类型操作的禁锢中解脱了出来，并且让我们可以使用某些非常强大的程序。对 RTTI 的需要，揭示了面向对象设计中许多有趣（并且复杂）的特性，同时也带来了关于如何组织程序的基本问题。 本章将讨论 Java 是如何在运行时识别对象和类">
<meta name="twitter:image" content="http://yoursite.com/2019/07/01/3/3_book/OnJava8/images/image-20190409114913825-4781754.png">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Pisces',
    sidebar: {"position":"left","display":"post","offset":12,"offset_float":12,"b2t":false,"scrollpercent":false,"onmobile":false},
    fancybox: true,
    tabs: true,
    motion: true,
    duoshuo: {
      userId: '0',
      author: '博主'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="http://yoursite.com/2019/07/01/3/3_book/OnJava8/19-Type-Information/">





  <title>第十九章 类型信息 | 水门的博客</title>
  














</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-Hans">

  
  
    
  

  <div class="container sidebar-position-left page-post-detail ">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/" class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">水门的博客</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <p class="site-subtitle"></p>
      
  </div>

  <div class="site-nav-toggle">
    <button>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br>
            
            首页
          </a>
        </li>
      
        
        <li class="menu-item menu-item-categories">
          <a href="/categories/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-th"></i> <br>
            
            分类
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-tags"></i> <br>
            
            标签
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br>
            
            归档
          </a>
        </li>
      
        
        <li class="menu-item menu-item-about">
          <a href="/about/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-user"></i> <br>
            
            关于
          </a>
        </li>
      

      
        <li class="menu-item menu-item-search">
          
            <a href="javascript:;" class="popup-trigger">
          
            
              <i class="menu-item-icon fa fa-search fa-fw"></i> <br>
            
            搜索
          </a>
        </li>
      
    </ul>
  

  
    <div class="site-search">
      
  <div class="popup search-popup local-search-popup">
  <div class="local-search-header clearfix">
    <span class="search-icon">
      <i class="fa fa-search"></i>
    </span>
    <span class="popup-btn-close">
      <i class="fa fa-times-circle"></i>
    </span>
    <div class="local-search-input-wrapper">
      <input autocomplete="off" placeholder="搜索..." spellcheck="false" type="text" id="local-search-input">
    </div>
  </div>
  <div id="local-search-result"></div>
</div>



    </div>
  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            

  <div id="posts" class="posts-expand">
    

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2019/07/01/3/3_book/OnJava8/19-Type-Information/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="kay wu">
      <meta itemprop="description" content>
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="水门的博客">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">第十九章 类型信息</h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2019-07-01T00:00:02+08:00">
                2019-07-01
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          
            <div class="post-wordcount">
              
                
                <span class="post-meta-item-icon">
                  <i class="fa fa-file-word-o"></i>
                </span>
                
                  <span class="post-meta-item-text">字数统计</span>
                
                <span title="字数统计">
                  20.9k
                </span>
              

              

              
            </div>
          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        <!-- Type Information -->
<h1 id="第十九章-类型信息"><a href="#第十九章-类型信息" class="headerlink" title="第十九章 类型信息"></a>第十九章 类型信息</h1><blockquote>
<p>RTTI（RunTime Type Information，运行时类型信息）能够在程序运行时发现和使用类型信息</p>
</blockquote>
<p>RTTI 把我们从只能在编译期进行面向类型操作的禁锢中解脱了出来，并且让我们可以使用某些非常强大的程序。对 RTTI 的需要，揭示了面向对象设计中许多有趣（并且复杂）的特性，同时也带来了关于如何组织程序的基本问题。</p>
<p>本章将讨论 Java 是如何在运行时识别对象和类信息的。主要有两种方式：</p>
<ol>
<li>“传统的” RTTI：假定我们在编译时已经知道了所有的类型；</li>
<li>“反射”机制：允许我们在运行时发现和使用类的信息。</li>
</ol>
<!-- The Need for RTTI -->
<h2 id="为什么需要-RTTI"><a href="#为什么需要-RTTI" class="headerlink" title="为什么需要 RTTI"></a>为什么需要 RTTI</h2><p>下面看一下我们已经很熟悉的一个例子，它使用了多态的类层次结构。基类 <code>Shape</code> 是泛化的类型，从它派生出了三个具体类： <code>Circle</code> 、<code>Square</code> 和 <code>Triangle</code>（见下图所示）。</p>
<p><img src="../images/image-20190409114913825-4781754.png" alt="多态例子Shape的类层次结构图"></p>
<p>这是一个典型的类层次结构图，基类位于顶部，派生类向下扩展。面向对象编程的一个基本目的是：让代码只操纵对基类(这里即 <code>Shape</code> )的引用。这样，如果你想添加一个新类(比如从 <code>Shape</code> 派生出 <code>Rhomboid</code>)来扩展程序，就不会影响原来的代码。在这个例子中，<code>Shape</code> 接口中动态绑定了 <code>draw()</code> 方法，这样做的目的就是让客户端程序员可以使用泛化的 <code>Shape</code> 引用来调用 <code>draw()</code>。<code>draw()</code> 方法在所有派生类里都会被覆盖，而且由于它是动态绑定的，所以即使通过 <code>Shape</code> 引用来调用它，也能产生恰当的行为，这就是多态。</p>
<p>因此，我们通常会创建一个具体的对象(<code>Circle</code>、<code>Square</code> 或者 <code>Triangle</code>)，把它向上转型成 <code>Shape</code> (忽略对象的具体类型)，并且在后面的程序中使用 <code>Shape</code> 引用来调用在具体对象中被重载的方法（如 <code>draw()</code>）。</p>
<p>代码如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// typeinfo/Shapes.java</span></span><br><span class="line"><span class="keyword">import</span> java.util.stream.*;</span><br><span class="line"></span><br><span class="line"><span class="keyword">abstract</span> <span class="class"><span class="keyword">class</span> <span class="title">Shape</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">draw</span><span class="params">()</span> </span>&#123; System.out.println(<span class="keyword">this</span> + <span class="string">".draw()"</span>); &#125;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">abstract</span> String <span class="title">toString</span><span class="params">()</span></span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Circle</span> <span class="keyword">extends</span> <span class="title">Shape</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">toString</span><span class="params">()</span> </span>&#123; <span class="keyword">return</span> <span class="string">"Circle"</span>; &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Square</span> <span class="keyword">extends</span> <span class="title">Shape</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">toString</span><span class="params">()</span> </span>&#123; <span class="keyword">return</span> <span class="string">"Square"</span>; &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Triangle</span> <span class="keyword">extends</span> <span class="title">Shape</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">toString</span><span class="params">()</span> </span>&#123; <span class="keyword">return</span> <span class="string">"Triangle"</span>; &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Shapes</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        Stream.of(</span><br><span class="line">            <span class="keyword">new</span> Circle(), <span class="keyword">new</span> Square(), <span class="keyword">new</span> Triangle())</span><br><span class="line">            .forEach(Shape::draw);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>输出结果：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">Circle.draw()</span><br><span class="line">Square.draw()</span><br><span class="line">Triangle.draw()</span><br></pre></td></tr></table></figure>
<p>基类中包含 <code>draw()</code> 方法，它通过传递 <code>this</code> 参数传递给 <code>System.out.println()</code>，间接地使用 <code>toString()</code> 打印类标识符(注意：这里将 <code>toString()</code> 声明为 <code>abstract</code>，以此强制继承者覆盖该方法，并防止对 <code>Shape</code> 的实例化)。如果某个对象出现在字符串表达式中(涉及”+”和字符串对象的表达式)，<code>toString()</code> 方法就会被自动调用，以生成表示该对象的 <code>String</code>。每个派生类都要覆盖（从 <code>Object</code> 继承来的）<code>toString()</code> 方法，这样 <code>draw()</code> 在不同情况下就打印出不同的消息(多态)。</p>
<p>这个例子中，在把 <code>Shape</code> 对象放入 <code>Stream&lt;Shape&gt;</code> 中时就会进行向上转型(隐式)，但在向上转型的时候也丢失了这些对象的具体类型。对 <code>stream</code> 而言，它们只是 <code>Shape</code> 对象。</p>
<p>严格来说，<code>Stream&lt;Shape&gt;</code> 实际上是把放入其中的所有对象都当做 <code>Object</code> 对象来持有，只是取元素时会自动将其类型转为 <code>Shape</code>。这也是 RTTI 最基本的使用形式，因为在 Java 中，所有类型转换的正确性检查都是在运行时进行的。这也正是 RTTI 的含义所在：在运行时，识别一个对象的类型。</p>
<p>另外在这个例子中，类型转换并不彻底：<code>Object</code> 被转型为 <code>Shape</code> ，而不是 <code>Circle</code>、<code>Square</code> 或者 <code>Triangle</code>。这是因为目前我们只能确保这个 <code>Stream&lt;Shape&gt;</code> 保存的都是 <code>Shape</code>：</p>
<ul>
<li>编译期，<code>stream</code> 和 Java 泛型系统确保放入 <code>stream</code> 的都是 <code>Shape</code> 对象（<code>Shape</code> 子类的对象也可视为 <code>Shape</code> 的对象），否则编译器会报错；</li>
<li>运行时，自动类型转换确保了从 <code>stream</code> 中取出的对象都是 <code>Shape</code> 类型。</li>
</ul>
<p>接下来就是多态机制的事了，<code>Shape</code> 对象实际执行什么样的代码，是由引用所指向的具体对象（<code>Circle</code>、<code>Square</code> 或者 <code>Triangle</code>）决定的。这也符合我们编写代码的一般需求，通常，我们希望大部分代码尽可能少了解对象的具体类型，而是只与对象家族中的一个通用表示打交道（本例中即为 <code>Shape</code>）。这样，代码会更容易写，更易读和维护；设计也更容易实现，更易于理解和修改。所以多态是面向对象的基本目标。</p>
<p>但是，有时你会碰到一些编程问题，在这些问题中如果你能知道某个泛化引用的具体类型，就可以把问题轻松解决。例如，假设我们允许用户将某些几何形状高亮显示，现在希望找到屏幕上所有高亮显示的三角形；或者，我们现在需要旋转所有图形，但是想跳过圆形(因为圆形旋转没有意义)。这时我们就希望知道 <code>Stream&lt;Shape&gt;</code> 里边的形状具体是什么类型，而 Java 实际上也满足了我们的这种需求。使用 RTTI，我们可以查询某个 <code>Shape</code> 引用所指向对象的确切类型，然后选择或者剔除特例。</p>
<!-- The Class Object -->
<h2 id="Class-对象"><a href="#Class-对象" class="headerlink" title="Class 对象"></a><code>Class</code> 对象</h2><p>要理解 RTTI 在 Java 中的工作原理，首先必须知道类型信息在运行时是如何表示的。这项工作是由称为 <strong><code>Class</code>对象</strong> 的特殊对象完成的，它包含了与类有关的信息。实际上，<code>Class</code> 对象就是用来创建该类所有”常规”对象的。Java 使用 <code>Class</code> 对象来实现 RTTI，即便是类型转换这样的操作都是用 <code>Class</code> 对象实现的。不仅如此，<code>Class</code> 类还提供了很多使用 RTTI 的其它方式。</p>
<p>类是程序的一部分，每个类都有一个 <code>Class</code> 对象。换言之，每当我们编写并且编译了一个新类，就会产生一个 <code>Class</code> 对象（更恰当的说，是被保存在一个同名的 <code>.class</code> 文件中）。为了生成这个类的对象，Java 虚拟机 (JVM) 先会调用”类加载器”子系统把这个类加载到内存中。</p>
<p>类加载器子系统可能包含一条类加载器链，但有且只有一个<strong>原生类加载器</strong>，它是 JVM 实现的一部分。原生类加载器加载的是”可信类”（包括 Java API 类）。它们通常是从本地盘加载的。在这条链中，通常不需要添加额外的类加载器，但是如果你有特殊需求（例如以某种特殊的方式加载类，以支持 Web 服务器应用，或者通过网络下载类），也可以挂载额外的类加载器。</p>
<p>所有的类都是第一次使用时动态加载到 JVM 中的，当程序创建第一个对类的静态成员的引用时，就会加载这个类。</p>
<blockquote>
<p>其实构造器也是类的静态方法，虽然构造器前面并没有 <code>static</code> 关键字。所以，使用 <code>new</code> 操作符创建类的新对象，这个操作也算作对类的静态成员引用。</p>
</blockquote>
<p>因此，Java 程序在它开始运行之前并没有被完全加载，很多部分是在需要时才会加载。这一点与许多传统编程语言不同，动态加载使得 Java 具有一些静态加载语言（如 C++）很难或者根本不可能实现的特性。</p>
<p>类加载器首先会检查这个类的 <code>Class</code> 对象是否已经加载，如果尚未加载，默认的类加载器就会根据类名查找 <code>.class</code> 文件（如果有附加的类加载器，这时候可能就会在数据库中或者通过其它方式获得字节码）。这个类的字节码被加载后，JVM 会对其进行验证，确保它没有损坏，并且不包含不良的 Java 代码(这是 Java 安全防范的一种措施)。</p>
<p>一旦某个类的 <code>Class</code> 对象被载入内存，它就可以用来创建这个类的所有对象。下面的示范程序可以证明这点：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// typeinfo/SweetShop.java</span></span><br><span class="line"><span class="comment">// 检查类加载器工作方式</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Cookie</span> </span>&#123;</span><br><span class="line">    <span class="keyword">static</span> &#123; System.out.println(<span class="string">"Loading Cookie"</span>); &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Gum</span> </span>&#123;</span><br><span class="line">    <span class="keyword">static</span> &#123; System.out.println(<span class="string">"Loading Gum"</span>); &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Candy</span> </span>&#123;</span><br><span class="line">    <span class="keyword">static</span> &#123; System.out.println(<span class="string">"Loading Candy"</span>); &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">SweetShop</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        System.out.println(<span class="string">"inside main"</span>);</span><br><span class="line">        <span class="keyword">new</span> Candy();</span><br><span class="line">        System.out.println(<span class="string">"After creating Candy"</span>);</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            Class.forName(<span class="string">"Gum"</span>);</span><br><span class="line">        &#125; <span class="keyword">catch</span>(ClassNotFoundException e) &#123;</span><br><span class="line">            System.out.println(<span class="string">"Couldn't find Gum"</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        System.out.println(<span class="string">"After Class.forName(\"Gum\")"</span>);</span><br><span class="line">        <span class="keyword">new</span> Cookie();</span><br><span class="line">        System.out.println(<span class="string">"After creating Cookie"</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>输出结果：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">inside main</span><br><span class="line">Loading Candy</span><br><span class="line">After creating Candy</span><br><span class="line">Loading Gum</span><br><span class="line">After Class.forName(&quot;Gum&quot;)</span><br><span class="line">Loading Cookie</span><br><span class="line">After creating Cookie</span><br></pre></td></tr></table></figure>
<p>上面的代码中，<code>Candy</code>、<code>Gum</code> 和 <code>Cookie</code> 这几个类都有一个 <code>static{...}</code> 静态初始化块，这些静态初始化块在类第一次被加载的时候就会执行。也就是说，静态初始化块会打印出相应的信息，告诉我们这些类分别是什么时候被加载了。而在主方法里边，创建对象的代码都放在了 <code>print()</code> 语句之间，以帮助我们判断类加载的时间点。</p>
<p>从输出中可以看到，<code>Class</code> 对象仅在需要的时候才会被加载，<code>static</code> 初始化是在类加载时进行的。</p>
<p>代码里面还有特别有趣的一行：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Class.forName(<span class="string">"Gum"</span>);</span><br></pre></td></tr></table></figure>
<p>所有 <code>Class</code> 对象都属于 <code>Class</code> 类，而且它跟其他普通对象一样，我们可以获取和操控它的引用(这也是类加载器的工作)。<code>forName()</code> 是 <code>Class</code> 类的一个静态方法，我们可以使用 <code>forName()</code> 根据目标类的类名（<code>String</code>）得到该类的 <code>Class</code> 对象。上面的代码忽略了 <code>forName()</code> 的返回值，因为那个调用是为了得到它产生的“副作用”。从结果可以看出，<code>forName()</code> 执行的副作用是如果 <code>Gum</code> 类没有被加载就加载它，而在加载的过程中，<code>Gum</code> 的 <code>static</code> 初始化块被执行了。</p>
<p>还需要注意的是，如果 <code>Class.forName()</code> 找不到要加载的类，它就会抛出异常 <code>ClassNotFoundException</code>。上面的例子中我们只是简单地报告了问题，但在更严密的程序里，就要考虑在异常处理程序中把问题解决掉（具体例子详见<a href="./25-Patterns">设计模式</a>章节）。</p>
<p>无论何时，只要你想在运行时使用类型信息，就必须先得到那个 <code>Class</code> 对象的引用。<code>Class.forName()</code> 就是实现这个功能的一个便捷途径，因为使用该方法你不需要先持有这个类型 的对象。但是，如果你已经拥有了目标类的对象，那就可以通过调用 <code>getClass()</code> 方法来获取 <code>Class</code> 引用了，这个方法来自根类 <code>Object</code>，它将返回表示该对象实际类型的 <code>Class</code> 对象的引用。<code>Class</code> 包含很多有用的方法，下面代码展示了其中的一部分：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// typeinfo/toys/ToyTest.java</span></span><br><span class="line"><span class="comment">// 测试 Class 类</span></span><br><span class="line"><span class="comment">// &#123;java typeinfo.toys.ToyTest&#125;</span></span><br><span class="line"><span class="keyword">package</span> typeinfo.toys;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">interface</span> <span class="title">HasBatteries</span> </span>&#123;&#125;</span><br><span class="line"><span class="class"><span class="keyword">interface</span> <span class="title">Waterproof</span> </span>&#123;&#125;</span><br><span class="line"><span class="class"><span class="keyword">interface</span> <span class="title">Shoots</span> </span>&#123;&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Toy</span> </span>&#123;</span><br><span class="line">    <span class="comment">// 注释下面的无参数构造器会引起 NoSuchMethodError 错误</span></span><br><span class="line">    Toy() &#123;&#125;</span><br><span class="line">    Toy(<span class="keyword">int</span> i) &#123;&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">FancyToy</span> <span class="keyword">extends</span> <span class="title">Toy</span></span></span><br><span class="line"><span class="class"><span class="keyword">implements</span> <span class="title">HasBatteries</span>, <span class="title">Waterproof</span>, <span class="title">Shoots</span> </span>&#123;</span><br><span class="line">    FancyToy() &#123; <span class="keyword">super</span>(<span class="number">1</span>); &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ToyTest</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">printInfo</span><span class="params">(Class cc)</span> </span>&#123;</span><br><span class="line">        System.out.println(<span class="string">"Class name: "</span> + cc.getName() +</span><br><span class="line">            <span class="string">" is interface? ["</span> + cc.isInterface() + <span class="string">"]"</span>);</span><br><span class="line">        System.out.println(</span><br><span class="line">            <span class="string">"Simple name: "</span> + cc.getSimpleName());</span><br><span class="line">        System.out.println(</span><br><span class="line">            <span class="string">"Canonical name : "</span> + cc.getCanonicalName());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        Class c = <span class="keyword">null</span>;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            c = Class.forName(<span class="string">"typeinfo.toys.FancyToy"</span>);</span><br><span class="line">        &#125; <span class="keyword">catch</span>(ClassNotFoundException e) &#123;</span><br><span class="line">            System.out.println(<span class="string">"Can't find FancyToy"</span>);</span><br><span class="line">            System.exit(<span class="number">1</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        printInfo(c);</span><br><span class="line">        <span class="keyword">for</span>(Class face : c.getInterfaces())</span><br><span class="line">            printInfo(face);</span><br><span class="line"></span><br><span class="line">        Class up = c.getSuperclass();</span><br><span class="line">        Object obj = <span class="keyword">null</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="comment">// Requires no-arg constructor:</span></span><br><span class="line">            obj = up.newInstance();</span><br><span class="line">        &#125; <span class="keyword">catch</span>(InstantiationException e) &#123;</span><br><span class="line">            System.out.println(<span class="string">"Cannot instantiate"</span>);</span><br><span class="line">            System.exit(<span class="number">1</span>);</span><br><span class="line">        &#125; <span class="keyword">catch</span>(IllegalAccessException e) &#123;</span><br><span class="line">            System.out.println(<span class="string">"Cannot access"</span>);</span><br><span class="line">            System.exit(<span class="number">1</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        printInfo(obj.getClass());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>输出结果：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">Class name: typeinfo.toys.FancyToy is interface?</span><br><span class="line">[false]</span><br><span class="line">Simple name: FancyToy</span><br><span class="line">Canonical name : typeinfo.toys.FancyToy</span><br><span class="line">Class name: typeinfo.toys.HasBatteries is interface?</span><br><span class="line">[true]</span><br><span class="line">Simple name: HasBatteries</span><br><span class="line">Canonical name : typeinfo.toys.HasBatteries</span><br><span class="line">Class name: typeinfo.toys.Waterproof is interface?</span><br><span class="line">[true]</span><br><span class="line">Simple name: Waterproof</span><br><span class="line">Canonical name : typeinfo.toys.Waterproof</span><br><span class="line">Class name: typeinfo.toys.Shoots is interface? [true]</span><br><span class="line">Simple name: Shoots</span><br><span class="line">Canonical name : typeinfo.toys.Shoots</span><br><span class="line">Class name: typeinfo.toys.Toy is interface? [false]</span><br><span class="line">Simple name: Toy</span><br><span class="line">Canonical name : typeinfo.toys.Toy</span><br></pre></td></tr></table></figure>
<p><code>FancyToy</code> 继承自 <code>Toy</code> 并实现了 <code>HasBatteries</code>、<code>Waterproof</code> 和 <code>Shoots</code> 接口。在 <code>main</code> 方法中，我们创建了一个 <code>Class</code> 引用，然后在 <code>try</code> 语句里边用 <code>forName()</code> 方法创建了一个 <code>FancyToy</code> 的类对象并赋值给该引用。需要注意的是，传递给 <code>forName()</code> 的字符串必须使用类的全限定名（包含包名）。</p>
<p><code>printInfo()</code> 函数使用 <code>getName()</code> 来产生完整类名，使用 <code>getSimpleName()</code> 产生不带包名的类名，<code>getCanonicalName()</code> 也是产生完整类名（除内部类和数组外，对大部分类产生的结果与 <code>getName()</code> 相同）。<code>isInterface()</code> 用于判断某个 <code>Class</code> 对象代表的是否为一个接口。因此，通过 <code>Class</code> 对象，你可以得到关于该类型的所有信息。</p>
<p>在主方法中调用的 <code>Class.getInterfaces()</code> 方法返回的是存放 <code>Class</code> 对象的数组，里面的 <code>Class</code> 对象表示的是那个类实现的接口。</p>
<p>另外，你还可以调用 <code>getSuperclass()</code> 方法来得到父类的 <code>Class</code> 对象，再用父类的 <code>Class</code> 对象调用该方法，重复多次，你就可以得到一个对象完整的类继承结构。</p>
<p><code>Class</code> 对象的 <code>newInstance()</code> 方法是实现“虚拟构造器”的一种途径，虚拟构造器可以让你在不知道一个类的确切类型的时候，创建这个类的对象。在前面的例子中，<code>up</code> 只是一个 <code>Class</code> 对象的引用，在编译期并不知道这个引用会指向哪个类的 <code>Class</code> 对象。当你创建新实例时，会得到一个 <code>Object</code> 引用，但是这个引用指向的是 <code>Toy</code> 对象。当然，由于得到的是 <code>Object</code> 引用，目前你只能给它发送 <code>Object</code> 对象能够接受的调用。而如果你想请求具体对象才有的调用，你就得先获取该对象更多的类型信息，并执行某种转型。另外，使用 <code>newInstance()</code> 来创建的类，必须带有无参数的构造器。在本章稍后部分，你将会看到如何通过 Java 的反射 API，用任意的构造器来动态地创建类的对象。</p>
<h3 id="类字面常量"><a href="#类字面常量" class="headerlink" title="类字面常量"></a>类字面常量</h3><p>Java 还提供了另一种方法来生成类对象的引用：<strong>类字面常量</strong>。对上述程序来说，就像这样：<code>FancyToy.class;</code>。这样做不仅更简单，而且更安全，因为它在编译时就会受到检查（因此不必放在 <code>try</code> 语句块中）。并且它根除了对 <code>forName()</code> 方法的调用，所以效率更高。</p>
<p>类字面常量不仅可以应用于普通类，也可以应用于接口、数组以及基本数据类型。另外，对于基本数据类型的包装类，还有一个标准字段 <code>TYPE</code>。<code>TYPE</code> 字段是一个引用，指向对应的基本数据类型的 <code>Class</code> 对象，如下所示：</p>
<figure><br><table style="text-align:center;"><br>  <thead><br>    <tr><br>      <th colspan="2">…等价于…</th><br>    </tr><br>  </thead><br>  <tbody><br>    <tr><br>      <td>boolean.class</td><br>      <td>Boolean.TYPE</td><br>    </tr><br>    <tr><br>      <td>char.class</td><br>      <td>Character.TYPE</td><br>    </tr><br>    <tr><br>      <td>byte.class</td><br>      <td>Byte.TYPE</td><br>    </tr><br>    <tr><br>      <td>short.class</td><br>      <td>Short.TYPE</td><br>    </tr><br>    <tr><br>      <td>int.class</td><br>      <td>Integer.TYPE</td><br>    </tr><br>    <tr><br>      <td>long.class</td><br>      <td>Long.TYPE</td><br>    </tr><br>    <tr><br>      <td>float.class</td><br>      <td>Float.TYPE</td><br>    </tr><br>    <tr><br>      <td>double.class</td><br>      <td>Double.TYPE</td><br>    </tr><br>    <tr><br>      <td>void.class</td><br>      <td>Void.TYPE</td><br>    </tr><br>  </tbody><br></table><br></figure>

<p>我的建议是使用 <code>.class</code> 的形式，以保持与普通类的一致性。</p>
<p>注意，有一点很有趣：当使用 <code>.class</code> 来创建对 <code>Class</code> 对象的引用时，不会自动地初始化该 <code>Class</code> 对象。为了使用类而做的准备工作实际包含三个步骤：</p>
<ol>
<li><p><strong>加载</strong>，这是由类加载器执行的。该步骤将查找字节码（通常在 classpath 所指定的路径中查找，但这并非是必须的），并从这些字节码中创建一个 <code>Class</code> 对象。</p>
</li>
<li><p><strong>链接</strong>。在链接阶段将验证类中的字节码，为 <code>static</code> 字段分配存储空间，并且如果需要的话，将解析这个类创建的对其他类的所有引用。</p>
</li>
<li><p><strong>初始化</strong>。如果该类具有超类，则先初始化超类，执行 <code>static</code> 初始化器和 <code>static</code> 初始化块。</p>
</li>
</ol>
<p>直到第一次引用一个 <code>static</code> 方法（构造器隐式地是 <code>static</code>）或者非常量的 <code>static</code> 字段，才会进行类初始化。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// typeinfo/ClassInitialization.java</span></span><br><span class="line"><span class="keyword">import</span> java.util.*;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Initable</span> </span>&#123;</span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> STATIC_FINAL = <span class="number">47</span>;</span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> STATIC_FINAL2 =</span><br><span class="line">        ClassInitialization.rand.nextInt(<span class="number">1000</span>);</span><br><span class="line">    <span class="keyword">static</span> &#123;</span><br><span class="line">        System.out.println(<span class="string">"Initializing Initable"</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Initable2</span> </span>&#123;</span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">int</span> staticNonFinal = <span class="number">147</span>;</span><br><span class="line">    <span class="keyword">static</span> &#123;</span><br><span class="line">        System.out.println(<span class="string">"Initializing Initable2"</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Initable3</span> </span>&#123;</span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">int</span> staticNonFinal = <span class="number">74</span>;</span><br><span class="line">    <span class="keyword">static</span> &#123;</span><br><span class="line">        System.out.println(<span class="string">"Initializing Initable3"</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ClassInitialization</span> </span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> Random rand = <span class="keyword">new</span> Random(<span class="number">47</span>);</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span></span><br><span class="line">    main(String[] args) <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        Class initable = Initable.class;</span><br><span class="line">        System.out.println(<span class="string">"After creating Initable ref"</span>);</span><br><span class="line">        <span class="comment">// Does not trigger initialization:</span></span><br><span class="line">        System.out.println(Initable.STATIC_FINAL);</span><br><span class="line">        <span class="comment">// Does trigger initialization:</span></span><br><span class="line">        System.out.println(Initable.STATIC_FINAL2);</span><br><span class="line">        <span class="comment">// Does trigger initialization:</span></span><br><span class="line">        System.out.println(Initable2.staticNonFinal);</span><br><span class="line">        Class initable3 = Class.forName(<span class="string">"Initable3"</span>);</span><br><span class="line">        System.out.println(<span class="string">"After creating Initable3 ref"</span>);</span><br><span class="line">        System.out.println(Initable3.staticNonFinal);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>输出结果：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">After creating Initable ref</span><br><span class="line">47</span><br><span class="line">Initializing Initable</span><br><span class="line">258</span><br><span class="line">Initializing Initable2</span><br><span class="line">147</span><br><span class="line">Initializing Initable3</span><br><span class="line">After creating Initable3 ref</span><br><span class="line">74</span><br></pre></td></tr></table></figure>
<p>初始化有效地实现了尽可能的“惰性”，从对 <code>initable</code> 引用的创建中可以看到，仅使用 <code>.class</code> 语法来获得对类对象的引用不会引发初始化。但与此相反，使用 <code>Class.forName()</code> 来产生 <code>Class</code> 引用会立即就进行初始化，如 <code>initable3</code>。</p>
<p>如果一个 <code>static final</code> 值是“编译期常量”（如 <code>Initable.staticFinal</code>），那么这个值不需要对 <code>Initable</code> 类进行初始化就可以被读取。但是，如果只是将一个字段设置成为 <code>static</code> 和 <code>final</code>，还不足以确保这种行为。例如，对 <code>Initable.staticFinal2</code> 的访问将强制进行类的初始化，因为它不是一个编译期常量。</p>
<p>如果一个 <code>static</code> 字段不是 <code>final</code> 的，那么在对它访问时，总是要求在它被读取之前，要先进行链接（为这个字段分配存储空间）和初始化（初始化该存储空间），就像在对 <code>Initable2.staticNonFinal</code> 的访问中所看到的那样。</p>
<h3 id="泛化的-Class-引用"><a href="#泛化的-Class-引用" class="headerlink" title="泛化的 Class 引用"></a>泛化的 <code>Class</code> 引用</h3><p><code>Class</code> 引用总是指向某个 <code>Class</code> 对象，而 <code>Class</code> 对象可以用于产生类的实例，并且包含可作用于这些实例的所有方法代码。它还包含该类的 <code>static</code> 成员，因此 <code>Class</code> 引用表明了它所指向对象的确切类型，而该对象便是 <code>Class</code> 类的一个对象。</p>
<!-- > 译者的理解： `Class` 对象是 `Class` 类产生的对象，而再往深一点说，`Class` 类的 `Class` 对象（`Class.class`）也是其本类产生的对象。即一切皆对象，类也是一种对象。 -->
<p>但是，Java 设计者看准机会，将它的类型变得更具体了一些。Java 引入泛型语法之后，我们可以使用泛型对 <code>Class</code> 引用所指向的 <code>Class</code> 对象的类型进行限定。在下面的实例中，两种语法都是正确的：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// typeinfo/GenericClassReferences.java</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">GenericClassReferences</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        Class intClass = <span class="keyword">int</span>.class;</span><br><span class="line">        Class&lt;Integer&gt; genericIntClass = <span class="keyword">int</span>.class;</span><br><span class="line">        genericIntClass = Integer.class; <span class="comment">// 同一个东西</span></span><br><span class="line">        intClass = <span class="keyword">double</span>.class;</span><br><span class="line">        <span class="comment">// genericIntClass = double.class; // 非法</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>普通的类引用不会产生警告信息。你可以看到，普通的类引用可以重新赋值指向任何其他的 <code>Class</code> 对象，但是使用泛型限定的类引用只能指向其声明的类型。通过使用泛型语法，我们可以让编译器强制执行额外的类型检查。</p>
<p>那如果我们希望稍微放松一些限制，应该怎么办呢？乍一看，下面的操作好像是可以的：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Class&lt;Number&gt; geenericNumberClass = <span class="keyword">int</span>.class;</span><br></pre></td></tr></table></figure>
<p>这看起来似乎是起作用的，因为 <code>Integer</code> 继承自 <code>Number</code>。但事实却是不行，因为 <code>Integer</code> 的 <code>Class</code> 对象并不是 <code>Number</code>的 <code>Class</code> 对象的子类（这看起来可能有点诡异，我们将在<a href="./20-Generics">泛型</a>这一章详细讨论）。</p>
<p>为了在使用 <code>Class</code> 引用时放松限制，我们使用了通配符，它是 Java 泛型中的一部分。通配符就是 <code>?</code>，表示“任何事物”。因此，我们可以在上例的普通 <code>Class</code> 引用中添加通配符，并产生相同的结果：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// typeinfo/WildcardClassReferences.java</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">WildcardClassReferences</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        Class&lt;?&gt; intClass = <span class="keyword">int</span>.class;</span><br><span class="line">        intClass = <span class="keyword">double</span>.class;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>使用 <code>Class&lt;?&gt;</code> 比单纯使用 <code>Class</code> 要好，虽然它们是等价的，并且单纯使用 <code>Class</code> 不会产生编译器警告信息。使用 <code>Class&lt;?&gt;</code> 的好处是它表示你并非是碰巧或者由于疏忽才使用了一个非具体的类引用，而是特意为之。</p>
<p>为了创建一个限定指向某种类型或其子类的 <code>Class</code> 引用，我们需要将通配符与 <code>extends</code> 关键字配合使用，创建一个范围限定。这与仅仅声明 <code>Class&lt;Number&gt;</code> 不同，现在做如下声明：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// typeinfo/BoundedClassReferences.java</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">BoundedClassReferences</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        Class&lt;? extends Number&gt; bounded = <span class="keyword">int</span>.class;</span><br><span class="line">        bounded = <span class="keyword">double</span>.class;</span><br><span class="line">        bounded = Number.class;</span><br><span class="line">        <span class="comment">// Or anything else derived from Number.</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>向 <code>Class</code> 引用添加泛型语法的原因只是为了提供编译期类型检查，因此如果你操作有误，稍后就会发现这点。使用普通的 <code>Class</code> 引用你要确保自己不会犯错，因为一旦你犯了错误，就要等到运行时才能发现它，很不方便。</p>
<p>下面的示例使用了泛型语法，它保存了一个类引用，稍后又用 <code>newInstance()</code> 方法产生类的对象：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// typeinfo/DynamicSupplier.java</span></span><br><span class="line"><span class="keyword">import</span> java.util.function.*;</span><br><span class="line"><span class="keyword">import</span> java.util.stream.*;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">CountedInteger</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">long</span> counter;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">long</span> id = counter++;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">toString</span><span class="params">()</span> </span>&#123; <span class="keyword">return</span> Long.toString(id); &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">DynamicSupplier</span>&lt;<span class="title">T</span>&gt; <span class="keyword">implements</span> <span class="title">Supplier</span>&lt;<span class="title">T</span>&gt; </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> Class&lt;T&gt; type;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">DynamicSupplier</span><span class="params">(Class&lt;T&gt; type)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.type = type;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> T <span class="title">get</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> type.newInstance();</span><br><span class="line">        &#125; <span class="keyword">catch</span>(InstantiationException |</span><br><span class="line">                        IllegalAccessException e) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(e);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        Stream.generate(</span><br><span class="line">            <span class="keyword">new</span> DynamicSupplier&lt;&gt;(CountedInteger.class))</span><br><span class="line">            .skip(<span class="number">10</span>)</span><br><span class="line">            .limit(<span class="number">5</span>)</span><br><span class="line">            .forEach(System.out::println);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>输出结果:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td></tr></table></figure>
<p>注意，这个类必须假设与它一起工作的任何类型都有一个无参构造器，否则运行时会抛出异常。编译期对该程序不会产生任何警告信息。</p>
<p>当你将泛型语法用于 <code>Class</code> 对象时，<code>newInstance()</code> 将返回该对象的确切类型，而不仅仅只是在 <code>ToyTest.java</code> 中看到的基类 <code>Object</code>。然而，这在某种程度上有些受限：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// typeinfo/toys/GenericToyTest.java</span></span><br><span class="line"><span class="comment">// 测试 Class 类</span></span><br><span class="line"><span class="comment">// &#123;java typeinfo.toys.GenericToyTest&#125;</span></span><br><span class="line"><span class="keyword">package</span> typeinfo.toys;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">GenericToyTest</span> </span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span></span><br><span class="line">    main(String[] args) <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        Class&lt;FancyToy&gt; ftClass = FancyToy.class;</span><br><span class="line">        <span class="comment">// Produces exact type:</span></span><br><span class="line">        FancyToy fancyToy = ftClass.newInstance();</span><br><span class="line">        Class&lt;? <span class="keyword">super</span> FancyToy&gt; up =</span><br><span class="line">            ftClass.getSuperclass();</span><br><span class="line">        <span class="comment">// This won't compile:</span></span><br><span class="line">        <span class="comment">// Class&lt;Toy&gt; up2 = ftClass.getSuperclass();</span></span><br><span class="line">        <span class="comment">// Only produces Object:</span></span><br><span class="line">        Object obj = up.newInstance();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>如果你手头的是超类，那编译器将只允许你声明超类引用为“某个类，它是 <code>FancyToy</code> 的超类”，就像在表达式 <code>Class&lt;? super FancyToy&gt;</code> 中所看到的那样。而不会接收 <code>Class&lt;Toy&gt;</code> 这样的声明。这看上去显得有些怪，因为 <code>getSuperClass()</code> 方法返回的是基类（不是接口），并且编译器在编译期就知道它是什么类型了（在本例中就是 <code>Toy.class</code>），而不仅仅只是”某个类”。不管怎样，正是由于这种含糊性，<code>up.newInstance</code> 的返回值不是精确类型，而只是 <code>Object</code>。</p>
<h3 id="cast-方法"><a href="#cast-方法" class="headerlink" title="cast() 方法"></a><code>cast()</code> 方法</h3><p>Java 中还有用于 <code>Class</code> 引用的转型语法，即 <code>cast()</code> 方法：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// typeinfo/ClassCasts.java</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Building</span> </span>&#123;&#125;</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">House</span> <span class="keyword">extends</span> <span class="title">Building</span> </span>&#123;&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ClassCasts</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        Building b = <span class="keyword">new</span> House();</span><br><span class="line">        Class&lt;House&gt; houseType = House.class;</span><br><span class="line">        House h = houseType.cast(b);</span><br><span class="line">        h = (House)b; <span class="comment">// ... 或者这样做.</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><code>cast()</code> 方法接受参数对象，并将其类型转换为 <code>Class</code> 引用的类型。但是，如果观察上面的代码，你就会发现，与实现了相同功能的 <code>main</code> 方法中最后一行相比，这种转型好像做了很多额外的工作。</p>
<p><code>cast()</code> 在无法使用普通类型转换的情况下会显得非常有用，在你编写泛型代码（你将在<a href="./20-Generics">泛型</a>这一章学习到）时，如果你保存了 <code>Class</code> 引用，并希望以后通过这个引用来执行转型，你就需要用到 <code>cast()</code>。但事实却是这种情况非常少见，我发现整个 Java 类库中，只有一处使用了 <code>cast()</code>（在 <code>com.sun.mirror.util.DeclarationFilter</code> 中）。</p>
<p>Java 类库中另一个没有任何用处的特性就是 <code>Class.asSubclass()</code>，该方法允许你将一个 <code>Class</code> 对象转型为更加具体的类型。</p>
<h2 id="类型转换检测"><a href="#类型转换检测" class="headerlink" title="类型转换检测"></a>类型转换检测</h2><p>直到现在，我们已知的 RTTI 类型包括：</p>
<ol>
<li><p>传统的类型转换，如 “<code>(Shape)</code>”，由 RTTI 确保转换的正确性，如果执行了一个错误的类型转换，就会抛出一个 <code>ClassCastException</code> 异常。</p>
</li>
<li><p>代表对象类型的 <code>Class</code> 对象. 通过查询 <code>Class</code> 对象可以获取运行时所需的信息.</p>
</li>
</ol>
<p>在 C++ 中，经典的类型转换 “<code>(Shape)</code>” 并不使用 RTTI。它只是简单地告诉编译器将这个对象作为新的类型对待. 而 Java 会进行类型检查，这种类型转换一般被称作“类型安全的向下转型”。之所以称作“向下转型”，是因为传统上类继承图是这么画的。将 <code>Circle</code> 转换为 <code>Shape</code> 是一次向上转型, 将 <code>Shape</code> 转换为 <code>Circle</code> 是一次向下转型。但是, 因为我们知道 <code>Circle</code> 肯定是一个 <code>Shape</code>，所以编译器允许我们自由地做向上转型的赋值操作，且不需要任何显式的转型操作。当你给编译器一个 <code>Shape</code> 的时候，编译器并不知道它到底是什么类型的 <code>Shape</code>——它可能是 <code>Shape</code>，也可能是 <code>Shape</code> 的子类型，例如 <code>Circle</code>、<code>Square</code>、<code>Triangle</code> 或某种其他的类型。在编译期，编译器只能知道它是 <code>Shape</code>。因此，你需要使用显式地进行类型转换，以告知编译器你想转换的特定类型，否则编译器就不允许你执行向下转型赋值。 （编译器将会检查向下转型是否合理，因此它不允许向下转型到实际不是待转型类型的子类类型上）。</p>
<p>RTTI 在 Java 中还有第三种形式，那就是关键字 <code>instanceof</code>。它返回一个布尔值，告诉我们对象是不是某个特定类型的实例，可以用提问的方式使用它，就像这个样子：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span>(x <span class="keyword">instanceof</span> Dog)</span><br><span class="line">    ((Dog)x).bark();</span><br></pre></td></tr></table></figure>
<p>在将 <code>x</code> 的类型转换为 <code>Dog</code> 之前，<code>if</code> 语句会先检查 <code>x</code> 是否是 <code>Dog</code> 类型的对象。进行向下转型前，如果没有其他信息可以告诉你这个对象是什么类型，那么使用 <code>instanceof</code> 是非常重要的，否则会得到一个 <code>ClassCastException</code> 异常。</p>
<p>一般，可能想要查找某种类型（比如要找三角形，并填充为紫色），这时可以轻松地使用 <code>instanceof</code> 来度量所有对象。举个例子，假如你有一个类的继承体系，描述了 <code>Pet</code>（以及它们的主人，在后面一个例子中会用到这个特性）。在这个继承体系中的每个 <code>Individual</code> 都有一个 <code>id</code> 和一个可选的名字。尽管下面的类都继承自 <code>Individual</code>，但是 <code>Individual</code> 类复杂性较高，因此其代码将放在<a href="./Appendix-Collection-Topics">附录：容器</a>中进行解释说明。正如你所看到的，此处并不需要去了解 <code>Individual</code> 的代码——你只需了解你可以创建其具名或不具名的对象，并且每个 <code>Individual</code> 都有一个 <code>id()</code> 方法，如果你没有为 <code>Individual</code> 提供名字，<code>toString()</code> 方法只产生类型名。</p>
<p>下面是继承自 <code>Individual</code> 的类的继承体系：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// typeinfo/pets/Person.java</span></span><br><span class="line"><span class="keyword">package</span> typeinfo.pets;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Person</span> <span class="keyword">extends</span> <span class="title">Individual</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">Person</span><span class="params">(String name)</span> </span>&#123; <span class="keyword">super</span>(name); &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// typeinfo/pets/Pet.java</span></span><br><span class="line"><span class="keyword">package</span> typeinfo.pets;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Pet</span> <span class="keyword">extends</span> <span class="title">Individual</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">Pet</span><span class="params">(String name)</span> </span>&#123; <span class="keyword">super</span>(name); &#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">Pet</span><span class="params">()</span> </span>&#123; <span class="keyword">super</span>(); &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// typeinfo/pets/Dog.java</span></span><br><span class="line"><span class="keyword">package</span> typeinfo.pets;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Dog</span> <span class="keyword">extends</span> <span class="title">Pet</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">Dog</span><span class="params">(String name)</span> </span>&#123; <span class="keyword">super</span>(name); &#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">Dog</span><span class="params">()</span> </span>&#123; <span class="keyword">super</span>(); &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// typeinfo/pets/Mutt.java</span></span><br><span class="line"><span class="keyword">package</span> typeinfo.pets;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Mutt</span> <span class="keyword">extends</span> <span class="title">Dog</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">Mutt</span><span class="params">(String name)</span> </span>&#123; <span class="keyword">super</span>(name); &#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">Mutt</span><span class="params">()</span> </span>&#123; <span class="keyword">super</span>(); &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// typeinfo/pets/Pug.java</span></span><br><span class="line"><span class="keyword">package</span> typeinfo.pets;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Pug</span> <span class="keyword">extends</span> <span class="title">Dog</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">Pug</span><span class="params">(String name)</span> </span>&#123; <span class="keyword">super</span>(name); &#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">Pug</span><span class="params">()</span> </span>&#123; <span class="keyword">super</span>(); &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// typeinfo/pets/Cat.java</span></span><br><span class="line"><span class="keyword">package</span> typeinfo.pets;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Cat</span> <span class="keyword">extends</span> <span class="title">Pet</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">Cat</span><span class="params">(String name)</span> </span>&#123; <span class="keyword">super</span>(name); &#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">Cat</span><span class="params">()</span> </span>&#123; <span class="keyword">super</span>(); &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// typeinfo/pets/EgyptianMau.java</span></span><br><span class="line"><span class="keyword">package</span> typeinfo.pets;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">EgyptianMau</span> <span class="keyword">extends</span> <span class="title">Cat</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">EgyptianMau</span><span class="params">(String name)</span> </span>&#123; <span class="keyword">super</span>(name); &#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">EgyptianMau</span><span class="params">()</span> </span>&#123; <span class="keyword">super</span>(); &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// typeinfo/pets/Manx.java</span></span><br><span class="line"><span class="keyword">package</span> typeinfo.pets;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Manx</span> <span class="keyword">extends</span> <span class="title">Cat</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">Manx</span><span class="params">(String name)</span> </span>&#123; <span class="keyword">super</span>(name); &#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">Manx</span><span class="params">()</span> </span>&#123; <span class="keyword">super</span>(); &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// typeinfo/pets/Cymric.java</span></span><br><span class="line"><span class="keyword">package</span> typeinfo.pets;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Cymric</span> <span class="keyword">extends</span> <span class="title">Manx</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">Cymric</span><span class="params">(String name)</span> </span>&#123; <span class="keyword">super</span>(name); &#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">Cymric</span><span class="params">()</span> </span>&#123; <span class="keyword">super</span>(); &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// typeinfo/pets/Rodent.java</span></span><br><span class="line"><span class="keyword">package</span> typeinfo.pets;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Rodent</span> <span class="keyword">extends</span> <span class="title">Pet</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">Rodent</span><span class="params">(String name)</span> </span>&#123; <span class="keyword">super</span>(name); &#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">Rodent</span><span class="params">()</span> </span>&#123; <span class="keyword">super</span>(); &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// typeinfo/pets/Rat.java</span></span><br><span class="line"><span class="keyword">package</span> typeinfo.pets;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Rat</span> <span class="keyword">extends</span> <span class="title">Rodent</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">Rat</span><span class="params">(String name)</span> </span>&#123; <span class="keyword">super</span>(name); &#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">Rat</span><span class="params">()</span> </span>&#123; <span class="keyword">super</span>(); &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// typeinfo/pets/Mouse.java</span></span><br><span class="line"><span class="keyword">package</span> typeinfo.pets;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Mouse</span> <span class="keyword">extends</span> <span class="title">Rodent</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">Mouse</span><span class="params">(String name)</span> </span>&#123; <span class="keyword">super</span>(name); &#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">Mouse</span><span class="params">()</span> </span>&#123; <span class="keyword">super</span>(); &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// typeinfo/pets/Hamster.java</span></span><br><span class="line"><span class="keyword">package</span> typeinfo.pets;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Hamster</span> <span class="keyword">extends</span> <span class="title">Rodent</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">Hamster</span><span class="params">(String name)</span> </span>&#123; <span class="keyword">super</span>(name); &#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">Hamster</span><span class="params">()</span> </span>&#123; <span class="keyword">super</span>(); &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>我们必须显式地为每一个子类编写无参构造器。因为我们有一个带一个参数的构造器，所以编译器不会自动地为我们加上无参构造器。</p>
<p>接下来，我们需要一个类，它可以随机地创建不同类型的宠物，同时，它还可以创建宠物数组和持有宠物的 <code>List</code>。为了使这个类更加普遍适用，我们将其定义为抽象类：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// typeinfo/pets/PetCreator.java</span></span><br><span class="line"><span class="comment">// Creates random sequences of Pets</span></span><br><span class="line"><span class="keyword">package</span> typeinfo.pets;</span><br><span class="line"><span class="keyword">import</span> java.util.*;</span><br><span class="line"><span class="keyword">import</span> java.util.function.*;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="class"><span class="keyword">class</span> <span class="title">PetCreator</span> <span class="keyword">implements</span> <span class="title">Supplier</span>&lt;<span class="title">Pet</span>&gt; </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> Random rand = <span class="keyword">new</span> Random(<span class="number">47</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// The List of the different types of Pet to create:</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">abstract</span> List&lt;Class&lt;? extends Pet&gt;&gt; types();</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Pet <span class="title">get</span><span class="params">()</span> </span>&#123; <span class="comment">// Create one random Pet</span></span><br><span class="line">        <span class="keyword">int</span> n = rand.nextInt(types().size());</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> types().get(n).newInstance();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (InstantiationException |</span><br><span class="line">                IllegalAccessException e) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(e);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>抽象的 <code>types()</code> 方法需要子类来实现，以此来获取 <code>Class</code> 对象构成的 <code>List</code>（这是模板方法设计模式的一种变体）。注意，其中类的类型被定义为“任何从 <code>Pet</code> 导出的类型”，因此 <code>newInstance()</code> 不需要转型就可以产生 <code>Pet</code>。<code>get()</code> 随机的选取出一个 <code>Class</code> 对象，然后可以通过 <code>Class.newInstance()</code> 来生成该类的新实例。</p>
<p>在调用 <code>newInstance()</code> 时，可能会出现两种异常。在紧跟 <code>try</code> 语句块后面的 <code>catch</code> 子句中可以看到对它们的处理。异常的名字再次成为了一种对错误类型相对比较有用的解释（<code>IllegalAccessException</code> 违反了 Java 安全机制，在本例中，表示默认构造器为 <code>private</code> 的情况）。</p>
<p>当你创建 <code>PetCreator</code> 的子类时，你需要为 <code>get()</code> 方法提供 <code>Pet</code> 类型的 <code>List</code>。<code>types()</code> 方法会简单地返回一个静态 <code>List</code> 的引用。下面是使用 <code>forName()</code> 的一个具体实现：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// typeinfo/pets/ForNameCreator.java</span></span><br><span class="line"><span class="keyword">package</span> typeinfo.pets;</span><br><span class="line"><span class="keyword">import</span> java.util.*;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ForNameCreator</span> <span class="keyword">extends</span> <span class="title">PetCreator</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> List&lt;Class&lt;? extends Pet&gt;&gt; types =</span><br><span class="line">            <span class="keyword">new</span> ArrayList&lt;&gt;();</span><br><span class="line">    <span class="comment">// 需要随机生成的类型名:</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> String[] typeNames = &#123;</span><br><span class="line">            <span class="string">"typeinfo.pets.Mutt"</span>,</span><br><span class="line">            <span class="string">"typeinfo.pets.Pug"</span>,</span><br><span class="line">            <span class="string">"typeinfo.pets.EgyptianMau"</span>,</span><br><span class="line">            <span class="string">"typeinfo.pets.Manx"</span>,</span><br><span class="line">            <span class="string">"typeinfo.pets.Cymric"</span>,</span><br><span class="line">            <span class="string">"typeinfo.pets.Rat"</span>,</span><br><span class="line">            <span class="string">"typeinfo.pets.Mouse"</span>,</span><br><span class="line">            <span class="string">"typeinfo.pets.Hamster"</span></span><br><span class="line">    &#125;;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@SuppressWarnings</span>(<span class="string">"unchecked"</span>)</span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">loader</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">for</span> (String name : typeNames)</span><br><span class="line">                types.add(</span><br><span class="line">                        (Class&lt;? extends Pet&gt;) Class.forName(name));</span><br><span class="line">        &#125; <span class="keyword">catch</span> (ClassNotFoundException e) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(e);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">static</span> &#123;</span><br><span class="line">        loader();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> List&lt;Class&lt;? extends Pet&gt;&gt; types() &#123;</span><br><span class="line">        <span class="keyword">return</span> types;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><code>loader()</code> 方法使用 <code>Class.forName()</code> 创建了 <code>Class</code> 对象的 <code>List</code>。这可能会导致 <code>ClassNotFoundException</code> 异常，因为你传入的是一个 <code>String</code> 类型的参数，它不能再编译期间被确认是否合理。由于 <code>Pet</code> 相关的文件在 <code>typeinfo</code> 包里面，所以使用它们的时候需要填写完整的包名。</p>
<p>为了使得 <code>List</code> 装入的是具体的 <code>Class</code> 对象，类型转换是必须的，它会产生一个编译时警告。<code>loader()</code> 方法是分开编写的，然后它被放入到一个静态代码块里，因为 <code>@SuppressWarning</code> 注解不能够直接放置在静态代码块之上。</p>
<p>为了对 <code>Pet</code> 进行计数，我们需要一个能跟踪不同类型的 <code>Pet</code> 的工具。<code>Map</code> 的是这个需求的首选，我们将 <code>Pet</code> 类型名作为键，将保存 <code>Pet</code> 数量的 <code>Integer</code> 作为值。通过这种方式，你就看可以询问：“有多少个 <code>Hamster</code> 对象？”我们可以使用 <code>instanceof</code> 来对 <code>Pet</code> 进行计数：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// typeinfo/PetCount.java</span></span><br><span class="line"><span class="comment">// 使用 instanceof</span></span><br><span class="line"><span class="keyword">import</span> typeinfo.pets.*;</span><br><span class="line"><span class="keyword">import</span> java.util.*;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">PetCount</span> </span>&#123;</span><br><span class="line">    <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">Counter</span> <span class="keyword">extends</span> <span class="title">HashMap</span>&lt;<span class="title">String</span>, <span class="title">Integer</span>&gt; </span>&#123;</span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">count</span><span class="params">(String type)</span> </span>&#123;</span><br><span class="line">            Integer quantity = get(type);</span><br><span class="line">            <span class="keyword">if</span> (quantity == <span class="keyword">null</span>)</span><br><span class="line">                put(type, <span class="number">1</span>);</span><br><span class="line">            <span class="keyword">else</span></span><br><span class="line">                put(type, quantity + <span class="number">1</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span></span><br><span class="line">    countPets(PetCreator creator) &#123;</span><br><span class="line">        Counter counter = <span class="keyword">new</span> Counter();</span><br><span class="line">        <span class="keyword">for</span> (Pet pet : Pets.array(<span class="number">20</span>)) &#123;</span><br><span class="line">            <span class="comment">// List each individual pet:</span></span><br><span class="line">            System.out.print(</span><br><span class="line">                    pet.getClass().getSimpleName() + <span class="string">" "</span>);</span><br><span class="line">            <span class="keyword">if</span> (pet <span class="keyword">instanceof</span> Pet)</span><br><span class="line">                counter.count(<span class="string">"Pet"</span>);</span><br><span class="line">            <span class="keyword">if</span> (pet <span class="keyword">instanceof</span> Dog)</span><br><span class="line">                counter.count(<span class="string">"Dog"</span>);</span><br><span class="line">            <span class="keyword">if</span> (pet <span class="keyword">instanceof</span> Mutt)</span><br><span class="line">                counter.count(<span class="string">"Mutt"</span>);</span><br><span class="line">            <span class="keyword">if</span> (pet <span class="keyword">instanceof</span> Pug)</span><br><span class="line">                counter.count(<span class="string">"Pug"</span>);</span><br><span class="line">            <span class="keyword">if</span> (pet <span class="keyword">instanceof</span> Cat)</span><br><span class="line">                counter.count(<span class="string">"Cat"</span>);</span><br><span class="line">            <span class="keyword">if</span> (pet <span class="keyword">instanceof</span> EgyptianMau)</span><br><span class="line">                counter.count(<span class="string">"EgyptianMau"</span>);</span><br><span class="line">            <span class="keyword">if</span> (pet <span class="keyword">instanceof</span> Manx)</span><br><span class="line">                counter.count(<span class="string">"Manx"</span>);</span><br><span class="line">            <span class="keyword">if</span> (pet <span class="keyword">instanceof</span> Cymric)</span><br><span class="line">                counter.count(<span class="string">"Cymric"</span>);</span><br><span class="line">            <span class="keyword">if</span> (pet <span class="keyword">instanceof</span> Rodent)</span><br><span class="line">                counter.count(<span class="string">"Rodent"</span>);</span><br><span class="line">            <span class="keyword">if</span> (pet <span class="keyword">instanceof</span> Rat)</span><br><span class="line">                counter.count(<span class="string">"Rat"</span>);</span><br><span class="line">            <span class="keyword">if</span> (pet <span class="keyword">instanceof</span> Mouse)</span><br><span class="line">                counter.count(<span class="string">"Mouse"</span>);</span><br><span class="line">            <span class="keyword">if</span> (pet <span class="keyword">instanceof</span> Hamster)</span><br><span class="line">                counter.count(<span class="string">"Hamster"</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// Show the counts:</span></span><br><span class="line">        System.out.println();</span><br><span class="line">        System.out.println(counter);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        countPets(<span class="keyword">new</span> ForNameCreator());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>输出结果：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">Rat Manx Cymric Mutt Pug Cymric Pug Manx Cymric Rat</span><br><span class="line">EgyptianMau Hamster EgyptianMau Mutt Mutt Cymric Mouse</span><br><span class="line">Pug Mouse Cymric</span><br><span class="line">&#123;EgyptianMau=2, Pug=3, Rat=2, Cymric=5, Mouse=2, Cat=9,</span><br><span class="line">Manx=7, Rodent=5, Mutt=3, Dog=6, Pet=20, Hamster=1&#125;</span><br></pre></td></tr></table></figure>
<p>在 <code>countPets()</code> 中，一个简短的静态方法 <code>Pets.array()</code> 生产出了一个随机动物的集合。每个 <code>Pet</code> 都被 <code>instanceof</code> 检测到并计算了一遍。</p>
<p><code>instanceof</code> 有一个严格的限制：只可以将它与命名类型进行比较，而不能与 <code>Class</code> 对象作比较。在前面的例子中，你可能会觉得写出一大堆 <code>instanceof</code> 表达式很乏味，事实也是如此。但是，也没有办法让 <code>instanceof</code> 聪明起来，让它能够自动地创建一个 <code>Class</code> 对象的数组，然后将目标与这个数组中的对象逐一进行比较（稍后会看到一种替代方案）。其实这并不是那么大的限制，如果你在程序中写了大量的 <code>instanceof</code>，那就说明你的设计可能存在瑕疵。</p>
<h3 id="使用类字面量"><a href="#使用类字面量" class="headerlink" title="使用类字面量"></a>使用类字面量</h3><p>如果我们使用类字面量重新实现 <code>PetCreator</code> 类的话，其结果在很多方面都会更清晰：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// typeinfo/pets/LiteralPetCreator.java</span></span><br><span class="line"><span class="comment">// 使用类字面量</span></span><br><span class="line"><span class="comment">// &#123;java typeinfo.pets.LiteralPetCreator&#125;</span></span><br><span class="line"><span class="keyword">package</span> typeinfo.pets;</span><br><span class="line"><span class="keyword">import</span> java.util.*;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">LiteralPetCreator</span> <span class="keyword">extends</span> <span class="title">PetCreator</span> </span>&#123;</span><br><span class="line">    <span class="comment">// try 代码块不再需要</span></span><br><span class="line">    <span class="meta">@SuppressWarnings</span>(<span class="string">"unchecked"</span>)</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> List&lt;Class&lt;? extends Pet&gt;&gt; ALL_TYPES =</span><br><span class="line">            Collections.unmodifiableList(Arrays.asList(</span><br><span class="line">                    Pet.class, Dog.class, Cat.class, Rodent.class,</span><br><span class="line">                    Mutt.class, Pug.class, EgyptianMau.class,</span><br><span class="line">                    Manx.class, Cymric.class, Rat.class,</span><br><span class="line">                    Mouse.class, Hamster.class));</span><br><span class="line">    <span class="comment">// 用于随机创建的类型:</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> List&lt;Class&lt;? extends Pet&gt;&gt; TYPES =</span><br><span class="line">            ALL_TYPES.subList(ALL_TYPES.indexOf(Mutt.class),</span><br><span class="line">                    ALL_TYPES.size());</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> List&lt;Class&lt;? extends Pet&gt;&gt; types() &#123;</span><br><span class="line">        <span class="keyword">return</span> TYPES;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        System.out.println(TYPES);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>输出结果：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">[class typeinfo.pets.Mutt, class typeinfo.pets.Pug,</span><br><span class="line">class typeinfo.pets.EgyptianMau, class</span><br><span class="line">typeinfo.pets.Manx, class typeinfo.pets.Cymric, class</span><br><span class="line">typeinfo.pets.Rat, class typeinfo.pets.Mouse, class</span><br><span class="line">typeinfo.pets.Hamster]</span><br></pre></td></tr></table></figure>
<p>在即将到来的 <code>PetCount3.java</code> 示例中，我们用所有 <code>Pet</code> 类型预先加载一个 <code>Map</code>（不仅仅是随机生成的），因此 <code>ALL_TYPES</code> 类型的列表是必要的。<code>types</code> 列表是 <code>ALL_TYPES</code> 类型（使用 <code>List.subList()</code> 创建）的一部分，它包含精确的宠物类型，因此用于随机生成 <code>Pet</code>。</p>
<p>这次，<code>types</code> 的创建没有被 <code>try</code> 块包围，因为它是在编译时计算的，因此不会引发任何异常，不像 <code>Class.forName()</code>。</p>
<p>我们现在在 <code>typeinfo.pets</code> 库中有两个 <code>PetCreator</code> 的实现。为了提供第二个作为默认实现，我们可以创建一个使用 <code>LiteralPetCreator</code> 的 <em>外观模式</em>：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// typeinfo/pets/Pets.java</span></span><br><span class="line"><span class="comment">// Facade to produce a default PetCreator</span></span><br><span class="line"><span class="keyword">package</span> typeinfo.pets;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.*;</span><br><span class="line"><span class="keyword">import</span> java.util.stream.*;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Pets</span> </span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> PetCreator CREATOR = <span class="keyword">new</span> LiteralPetCreator();</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> Pet <span class="title">get</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> CREATOR.get();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> Pet[] array(<span class="keyword">int</span> size) &#123;</span><br><span class="line">        Pet[] result = <span class="keyword">new</span> Pet[size];</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; size; i++)</span><br><span class="line">            result[i] = CREATOR.get();</span><br><span class="line">        <span class="keyword">return</span> result;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> List&lt;Pet&gt; <span class="title">list</span><span class="params">(<span class="keyword">int</span> size)</span> </span>&#123;</span><br><span class="line">        List&lt;Pet&gt; result = <span class="keyword">new</span> ArrayList&lt;&gt;();</span><br><span class="line">        Collections.addAll(result, array(size));</span><br><span class="line">        <span class="keyword">return</span> result;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> Stream&lt;Pet&gt; <span class="title">stream</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> Stream.generate(CREATOR);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这还提供了对 <code>get()</code>、<code>array()</code> 和 <code>list()</code> 的间接调用，以及生成 <code>Stream&lt;Pet&gt;</code> 的新方法。</p>
<p>因为 <code>PetCount.countPets()</code> 采用了 <code>PetCreator</code> 参数，所以我们可以很容易地测试 <code>LiteralPetCreator</code>（通过上面的外观模式）：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// typeinfo/PetCount2.java</span></span><br><span class="line"><span class="keyword">import</span> typeinfo.pets.*;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">PetCount2</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        PetCount.countPets(Pets.CREATOR);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>输出结果：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">Rat Manx Cymric Mutt Pug Cymric Pug Manx Cymric Rat</span><br><span class="line">EgyptianMau Hamster EgyptianMau Mutt Mutt Cymric Mouse</span><br><span class="line">Pug Mouse Cymric</span><br><span class="line">&#123;EgyptianMau=2, Pug=3, Rat=2, Cymric=5, Mouse=2, Cat=9,</span><br><span class="line">Manx=7, Rodent=5, Mutt=3, Dog=6, Pet=20, Hamster=1&#125;</span><br></pre></td></tr></table></figure>
<p>输出与 <code>PetCount.java</code> 的输出相同。</p>
<h3 id="一个动态-instanceof-函数"><a href="#一个动态-instanceof-函数" class="headerlink" title="一个动态 instanceof 函数"></a>一个动态 <code>instanceof</code> 函数</h3><p><code>Class.isInstance()</code> 方法提供了一种动态测试对象类型的方法。因此，所有这些繁琐的 <code>instanceof</code> 语句都可以从 <code>PetCount.java</code> 中删除：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// typeinfo/PetCount3.java</span></span><br><span class="line"><span class="comment">// 使用 isInstance() 方法</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.*;</span><br><span class="line"><span class="keyword">import</span> java.util.stream.*;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> onjava.*;</span><br><span class="line"><span class="keyword">import</span> typeinfo.pets.*;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">PetCount3</span> </span>&#123;</span><br><span class="line">    <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">Counter</span> <span class="keyword">extends</span></span></span><br><span class="line"><span class="class">            <span class="title">LinkedHashMap</span>&lt;<span class="title">Class</span>&lt;? <span class="keyword">extends</span> <span class="title">Pet</span>&gt;, <span class="title">Integer</span>&gt; </span>&#123;</span><br><span class="line">        Counter() &#123;</span><br><span class="line">            <span class="keyword">super</span>(LiteralPetCreator.ALL_TYPES.stream()</span><br><span class="line">                    .map(lpc -&gt; Pair.make(lpc, <span class="number">0</span>))</span><br><span class="line">                    .collect(</span><br><span class="line">                            Collectors.toMap(Pair::key, Pair::value)));</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">count</span><span class="params">(Pet pet)</span> </span>&#123;</span><br><span class="line">            <span class="comment">// Class.isInstance() 替换 instanceof:</span></span><br><span class="line">            entrySet().stream()</span><br><span class="line">                    .filter(pair -&gt; pair.getKey().isInstance(pet))</span><br><span class="line">                    .forEach(pair -&gt;</span><br><span class="line">                            put(pair.getKey(), pair.getValue() + <span class="number">1</span>));</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> String <span class="title">toString</span><span class="params">()</span> </span>&#123;</span><br><span class="line">            String result = entrySet().stream()</span><br><span class="line">                    .map(pair -&gt; String.format(<span class="string">"%s=%s"</span>,</span><br><span class="line">                            pair.getKey().getSimpleName(),</span><br><span class="line">                            pair.getValue()))</span><br><span class="line">                    .collect(Collectors.joining(<span class="string">", "</span>));</span><br><span class="line">            <span class="keyword">return</span> <span class="string">"&#123;"</span> + result + <span class="string">"&#125;"</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        Counter petCount = <span class="keyword">new</span> Counter();</span><br><span class="line">        Pets.stream()</span><br><span class="line">                .limit(<span class="number">20</span>)</span><br><span class="line">                .peek(petCount::count)</span><br><span class="line">                .forEach(p -&gt; System.out.print(</span><br><span class="line">                        p.getClass().getSimpleName() + <span class="string">" "</span>));</span><br><span class="line">        System.out.println(<span class="string">"n"</span> + petCount);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>输出结果：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">Rat Manx Cymric Mutt Pug Cymric Pug Manx Cymric Rat</span><br><span class="line">EgyptianMau Hamster EgyptianMau Mutt Mutt Cymric Mouse</span><br><span class="line">Pug Mouse Cymric</span><br><span class="line">&#123;Rat=2, Pug=3, Mutt=3, Mouse=2, Cat=9, Dog=6, Cymric=5,</span><br><span class="line">EgyptianMau=2, Rodent=5, Hamster=1, Manx=7, Pet=20&#125;</span><br></pre></td></tr></table></figure>
<p>为了计算所有不同类型的 <code>Pet</code>，<code>Counter Map</code> 预先加载了来自 <code>LiteralPetCreator.ALL_TYPES</code> 的类型。如果不预先加载 <code>Map</code>，将只计数随机生成的类型，而不是像 <code>Pet</code> 和 <code>Cat</code> 这样的基本类型。</p>
<p><code>isInstance()</code> 方法消除了对 <code>instanceof</code> 表达式的需要。此外，这意味着你可以通过更改 <code>LiteralPetCreator.types</code> 数组来添加新类型的 <code>Pet</code>；程序的其余部分不需要修改（就像使用 <code>instanceof</code> 表达式时那样）。</p>
<p><code>toString()</code> 方法被重载，以便更容易读取输出，该输出仍与打印 <code>Map</code> 时看到的典型输出匹配。</p>
<h3 id="递归计数"><a href="#递归计数" class="headerlink" title="递归计数"></a>递归计数</h3><p><code>PetCount3.Counter</code> 中的 <code>Map</code> 预先加载了所有不同的 <code>Pet</code> 类。我们可以使用 <code>Class.isAssignableFrom()</code> 而不是预加载地图，并创建一个不限于计数 <code>Pet</code> 的通用工具：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// onjava/TypeCounter.java</span></span><br><span class="line"><span class="comment">// 计算类型家族的实例数</span></span><br><span class="line"><span class="keyword">package</span> onjava;</span><br><span class="line"><span class="keyword">import</span> java.util.*;</span><br><span class="line"><span class="keyword">import</span> java.util.stream.*;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">TypeCounter</span> <span class="keyword">extends</span> <span class="title">HashMap</span>&lt;<span class="title">Class</span>&lt;?&gt;, <span class="title">Integer</span>&gt; </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> Class&lt;?&gt; baseType;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">TypeCounter</span><span class="params">(Class&lt;?&gt; baseType)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.baseType = baseType;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">count</span><span class="params">(Object obj)</span> </span>&#123;</span><br><span class="line">        Class&lt;?&gt; type = obj.getClass();</span><br><span class="line">        <span class="keyword">if</span>(!baseType.isAssignableFrom(type))</span><br><span class="line">              <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(</span><br><span class="line">                obj + <span class="string">" incorrect type: "</span> + type +</span><br><span class="line">                <span class="string">", should be type or subtype of "</span> + baseType);</span><br><span class="line">        countClass(type);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">countClass</span><span class="params">(Class&lt;?&gt; type)</span> </span>&#123;</span><br><span class="line">        Integer quantity = get(type);</span><br><span class="line">        put(type, quantity == <span class="keyword">null</span> ? <span class="number">1</span> : quantity + <span class="number">1</span>);</span><br><span class="line">        Class&lt;?&gt; superClass = type.getSuperclass();</span><br><span class="line">        <span class="keyword">if</span>(superClass != <span class="keyword">null</span> &amp;&amp;</span><br><span class="line">               baseType.isAssignableFrom(superClass))</span><br><span class="line">              countClass(superClass);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">toString</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        String result = entrySet().stream()</span><br><span class="line">              .map(pair -&gt; String.format(<span class="string">"%s=%s"</span>,</span><br><span class="line">                pair.getKey().getSimpleName(),</span><br><span class="line">                pair.getValue()))</span><br><span class="line">              .collect(Collectors.joining(<span class="string">", "</span>));</span><br><span class="line">        <span class="keyword">return</span> <span class="string">"&#123;"</span> + result + <span class="string">"&#125;"</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><code>count()</code> 方法获取其参数的 <code>Class</code>，并使用 <code>isAssignableFrom()</code> 进行运行时检查，以验证传递的对象实际上属于感兴趣的层次结构。<code>countClass()</code> 首先计算类的确切类型。然后，如果 <code>baseType</code> 可以从超类赋值，则在超类上递归调用 <code>countClass()</code>。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// typeinfo/PetCount4.java</span></span><br><span class="line"><span class="keyword">import</span> typeinfo.pets.*;</span><br><span class="line"><span class="keyword">import</span> onjava.*;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">PetCount4</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        TypeCounter counter = <span class="keyword">new</span> TypeCounter(Pet.class);</span><br><span class="line">        Pets.stream()</span><br><span class="line">              .limit(<span class="number">20</span>)</span><br><span class="line">              .peek(counter::count)</span><br><span class="line">              .forEach(p -&gt; System.out.print(</span><br><span class="line">                p.getClass().getSimpleName() + <span class="string">" "</span>));</span><br><span class="line">        System.out.println(<span class="string">"n"</span> + counter);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>输出结果：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">Rat Manx Cymric Mutt Pug Cymric Pug Manx Cymric Rat</span><br><span class="line">EgyptianMau Hamster EgyptianMau Mutt Mutt Cymric Mouse</span><br><span class="line">Pug Mouse Cymric</span><br><span class="line">&#123;Dog=6, Manx=7, Cat=9, Rodent=5, Hamster=1, Rat=2,</span><br><span class="line">Pug=3, Mutt=3, Cymric=5, EgyptianMau=2, Pet=20,</span><br><span class="line">Mouse=2&#125;</span><br></pre></td></tr></table></figure>
<p>输出表明两个基类型以及精确类型都被计数了。</p>
<!-- Registered Factories -->
<h2 id="注册工厂"><a href="#注册工厂" class="headerlink" title="注册工厂"></a>注册工厂</h2><p>从 <code>Pet</code> 层次结构生成对象的问题是，每当向层次结构中添加一种新类型的 <code>Pet</code> 时，必须记住将其添加到 <code>LiteralPetCreator.java</code> 的条目中。在一个定期添加更多类的系统中，这可能会成为问题。</p>
<p>你可能会考虑向每个子类添加静态初始值设定项，因此初始值设定项会将其类添加到某个列表中。不幸的是，静态初始值设定项仅在首次加载类时调用，因此存在鸡和蛋的问题：生成器的列表中没有类，因此它无法创建该类的对象，因此类不会被加载并放入列表中。</p>
<p>基本上，你必须自己手工创建列表（除非你编写了一个工具来搜索和分析源代码，然后创建和编译列表）。所以你能做的最好的事情就是把列表集中放在一个明显的地方。层次结构的基类可能是最好的地方。</p>
<p>我们在这里所做的另一个更改是使用<em>工厂方法</em>设计模式将对象的创建推迟到类本身。工厂方法可以以多态方式调用，并为你创建适当类型的对象。事实证明，<code>java.util.function.Supplier</code> 用 <code>T get()</code> 描述了原型工厂方法。协变返回类型允许 <code>get()</code> 为 <code>Supplier</code> 的每个子类实现返回不同的类型。</p>
<p>在本例中，基类 <code>Part</code> 包含一个工厂对象的静态列表，列表成员类型为 <code>Supplier&lt;Part&gt;</code>。对于应该由 <code>get()</code> 方法生成的类型的工厂，通过将它们添加到 <code>prototypes</code> 列表向基类“注册”。奇怪的是，这些工厂本身就是对象的实例。此列表中的每个对象都是用于创建其他对象的<em>原型</em>：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// typeinfo/RegisteredFactories.java</span></span><br><span class="line"><span class="comment">// 注册工厂到基础类</span></span><br><span class="line"><span class="keyword">import</span> java.util.*;</span><br><span class="line"><span class="keyword">import</span> java.util.function.*;</span><br><span class="line"><span class="keyword">import</span> java.util.stream.*;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Part</span> <span class="keyword">implements</span> <span class="title">Supplier</span>&lt;<span class="title">Part</span>&gt; </span>&#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">toString</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> getClass().getSimpleName();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">static</span> List&lt;Supplier&lt;? extends Part&gt;&gt; prototypes =</span><br><span class="line">        Arrays.asList(</span><br><span class="line">          <span class="keyword">new</span> FuelFilter(),</span><br><span class="line">          <span class="keyword">new</span> AirFilter(),</span><br><span class="line">          <span class="keyword">new</span> CabinAirFilter(),</span><br><span class="line">          <span class="keyword">new</span> OilFilter(),</span><br><span class="line">          <span class="keyword">new</span> FanBelt(),</span><br><span class="line">          <span class="keyword">new</span> PowerSteeringBelt(),</span><br><span class="line">          <span class="keyword">new</span> GeneratorBelt()</span><br><span class="line">        );</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> Random rand = <span class="keyword">new</span> Random(<span class="number">47</span>);</span><br><span class="line">    <span class="function"><span class="keyword">public</span> Part <span class="title">get</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">int</span> n = rand.nextInt(prototypes.size());</span><br><span class="line">        <span class="keyword">return</span> prototypes.get(n).get();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Filter</span> <span class="keyword">extends</span> <span class="title">Part</span> </span>&#123;&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">FuelFilter</span> <span class="keyword">extends</span> <span class="title">Filter</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> FuelFilter <span class="title">get</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> FuelFilter();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">AirFilter</span> <span class="keyword">extends</span> <span class="title">Filter</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> AirFilter <span class="title">get</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> AirFilter();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">CabinAirFilter</span> <span class="keyword">extends</span> <span class="title">Filter</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> CabinAirFilter <span class="title">get</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> CabinAirFilter();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">OilFilter</span> <span class="keyword">extends</span> <span class="title">Filter</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> OilFilter <span class="title">get</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> OilFilter();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Belt</span> <span class="keyword">extends</span> <span class="title">Part</span> </span>&#123;&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">FanBelt</span> <span class="keyword">extends</span> <span class="title">Belt</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> FanBelt <span class="title">get</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> FanBelt();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">GeneratorBelt</span> <span class="keyword">extends</span> <span class="title">Belt</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> GeneratorBelt <span class="title">get</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> GeneratorBelt();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">PowerSteeringBelt</span> <span class="keyword">extends</span> <span class="title">Belt</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> PowerSteeringBelt <span class="title">get</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> PowerSteeringBelt();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">RegisteredFactories</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        Stream.generate(<span class="keyword">new</span> Part())</span><br><span class="line">              .limit(<span class="number">10</span>)</span><br><span class="line">              .forEach(System.out::println);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>输出结果：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">GeneratorBelt</span><br><span class="line">CabinAirFilter</span><br><span class="line">GeneratorBelt</span><br><span class="line">AirFilter</span><br><span class="line">PowerSteeringBelt</span><br><span class="line">CabinAirFilter</span><br><span class="line">FuelFilter</span><br><span class="line">PowerSteeringBelt</span><br><span class="line">PowerSteeringBelt</span><br><span class="line">FuelFilter</span><br></pre></td></tr></table></figure>
<p>并非层次结构中的所有类都应实例化；这里的 <code>Filter</code> 和 <code>Belt</code> 只是分类器，这样你就不会创建任何一个类的实例，而是只创建它们的子类（请注意，如果尝试这样做，你将获得 <code>Part</code> 基类的行为）。</p>
<p>因为 <code>Part implements Supplier&lt;Part&gt;</code>，<code>Part</code> 通过其 <code>get()</code> 方法供应其他 <code>Part</code>。如果为基类 <code>Part</code> 调用 <code>get()</code>（或者如果 <code>generate()</code> 调用 <code>get()</code>），它将创建随机特定的 <code>Part</code> 子类型，每个子类型最终都从 <code>Part</code> 继承，并重写相应的 <code>get()</code> 以生成它们中的一个。</p>
<!-- Instanceof vs. Class Equivalence -->
<h2 id="类的等价比较"><a href="#类的等价比较" class="headerlink" title="类的等价比较"></a>类的等价比较</h2><p>当你查询类型信息时，需要注意：instanceof 的形式(即 <code>instanceof</code> 或 <code>isInstance()</code> ，这两者产生的结果相同) 和 与 Class 对象直接比较 这两者间存在重要区别。下面的例子展示了这种区别：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// typeinfo/FamilyVsExactType.java</span></span><br><span class="line"><span class="comment">// instanceof 与 class 的差别</span></span><br><span class="line"><span class="comment">// &#123;java typeinfo.FamilyVsExactType&#125;</span></span><br><span class="line"><span class="keyword">package</span> typeinfo;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Base</span> </span>&#123;&#125;</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Derived</span> <span class="keyword">extends</span> <span class="title">Base</span> </span>&#123;&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">FamilyVsExactType</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">test</span><span class="params">(Object x)</span> </span>&#123;</span><br><span class="line">        System.out.println(</span><br><span class="line">              <span class="string">"Testing x of type "</span> + x.getClass());</span><br><span class="line">        System.out.println(</span><br><span class="line">              <span class="string">"x instanceof Base "</span> + (x <span class="keyword">instanceof</span> Base));</span><br><span class="line">        System.out.println(</span><br><span class="line">              <span class="string">"x instanceof Derived "</span> + (x <span class="keyword">instanceof</span> Derived));</span><br><span class="line">        System.out.println(</span><br><span class="line">              <span class="string">"Base.isInstance(x) "</span> + Base.class.isInstance(x));</span><br><span class="line">        System.out.println(</span><br><span class="line">              <span class="string">"Derived.isInstance(x) "</span> +</span><br><span class="line">              Derived.class.isInstance(x));</span><br><span class="line">        System.out.println(</span><br><span class="line">              <span class="string">"x.getClass() == Base.class "</span> +</span><br><span class="line">              (x.getClass() == Base.class));</span><br><span class="line">        System.out.println(</span><br><span class="line">              <span class="string">"x.getClass() == Derived.class "</span> +</span><br><span class="line">              (x.getClass() == Derived.class));</span><br><span class="line">        System.out.println(</span><br><span class="line">              <span class="string">"x.getClass().equals(Base.class)) "</span>+</span><br><span class="line">              (x.getClass().equals(Base.class)));</span><br><span class="line">        System.out.println(</span><br><span class="line">              <span class="string">"x.getClass().equals(Derived.class)) "</span> +</span><br><span class="line">              (x.getClass().equals(Derived.class)));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        test(<span class="keyword">new</span> Base());</span><br><span class="line">        test(<span class="keyword">new</span> Derived());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>输出结果：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">Testing x of type class typeinfo.Base</span><br><span class="line">x instanceof Base true</span><br><span class="line">x instanceof Derived false</span><br><span class="line">Base.isInstance(x) true</span><br><span class="line">Derived.isInstance(x) false</span><br><span class="line">x.getClass() == Base.class true</span><br><span class="line">x.getClass() == Derived.class false</span><br><span class="line">x.getClass().equals(Base.class)) true</span><br><span class="line">x.getClass().equals(Derived.class)) false</span><br><span class="line">Testing x of type class typeinfo.Derived</span><br><span class="line">x instanceof Base true</span><br><span class="line">x instanceof Derived true</span><br><span class="line">Base.isInstance(x) true</span><br><span class="line">Derived.isInstance(x) true</span><br><span class="line">x.getClass() == Base.class false</span><br><span class="line">x.getClass() == Derived.class true</span><br><span class="line">x.getClass().equals(Base.class)) false</span><br><span class="line">x.getClass().equals(Derived.class)) true</span><br></pre></td></tr></table></figure>
<p><code>test()</code> 方法使用两种形式的 <code>instanceof</code> 对其参数执行类型检查。然后，它获取 <code>Class</code> 引用，并使用 <code>==</code> 和 <code>equals()</code> 测试 <code>Class</code> 对象的相等性。令人放心的是，<code>instanceof</code> 和 <code>isInstance()</code> 产生的结果相同， <code>equals()</code> 和 <code>==</code> 产生的结果也相同。但测试本身得出了不同的结论。与类型的概念一致，<code>instanceof</code> 说的是“你是这个类，还是从这个类派生的类？”。而如果使用 <code>==</code> 比较实际的<code>Class</code> 对象，则与继承无关 —— 它要么是确切的类型，要么不是。</p>
<!-- Reflection: Runtime Class Information -->
<h2 id="反射：运行时类信息"><a href="#反射：运行时类信息" class="headerlink" title="反射：运行时类信息"></a>反射：运行时类信息</h2><p>如果你不知道对象的确切类型，RTTI 会告诉你。但是，有一个限制：必须在编译时知道类型，才能使用 RTTI 检测它，并对信息做一些有用的事情。换句话说，编译器必须知道你使用的所有类。</p>
<p>起初，这看起来并没有那么大的限制，但是假设你引用了一个对不在程序空间中的对象。实际上，该对象的类在编译时甚至对程序都不可用。也许你从磁盘文件或网络连接中获得了大量的字节，并被告知这些字节代表一个类。由于这个类在编译器为你的程序生成代码后很长时间才会出现，你如何使用这样的类？</p>
<p>在传统编程环境中，这是一个牵强的场景。但是，当我们进入一个更大的编程世界时，会有一些重要的情况发生。第一个是基于组件的编程，你可以在应用程序构建器<em>集成开发环境</em>中使用<em>快速应用程序开发</em>（RAD）构建项目。这是一种通过将表示组件的图标移动到窗体上来创建程序的可视化方法。然后，通过在编程时设置这些组件的一些值来配置这些组件。这种设计时配置要求任何组件都是可实例化的，它公开自己的部分，并且允许读取和修改其属性。此外，处理<em>图形用户界面</em>（GUI）事件的组件必须公开有关适当方法的信息，以便 IDE 可以帮助程序员覆写这些事件处理方法。反射提供了检测可用方法并生成方法名称的机制。</p>
<p>在运行时发现类信息的另一个令人信服的动机是提供跨网络在远程平台上创建和执行对象的能力。这称为<em>远程方法调用</em>（RMI），它使 Java 程序的对象分布在许多机器上。这种分布有多种原因。如果你想加速一个计算密集型的任务，你可以把它分解成小块放到空闲的机器上。或者你可以将处理特定类型任务的代码（例如，多层次客户机/服务器体系结构中的“业务规则”）放在特定的机器上，这样机器就成为描述这些操作的公共存储库，并且可以很容易地更改它以影响系统中的每个人。分布式计算还支持专门的硬件，这些硬件可能擅长于某个特定的任务——例如矩阵转换——但对于通用编程来说不合适或过于昂贵。</p>
<p>类 <code>Class</code> 支持<em>反射</em>的概念， <code>java.lang.reflect</code> 库中包含类 <code>Field</code>、<code>Method</code> 和 <code>Constructor</code>（每一个都实现了 <code>Member</code> 接口）。这些类型的对象由 JVM 在运行时创建，以表示未知类中的对应成员。然后，可以使用 <code>Constructor</code> 创建新对象，<code>get()</code> 和 <code>set()</code> 方法读取和修改与 <code>Field</code> 对象关联的字段，<code>invoke()</code> 方法调用与 <code>Method</code> 对象关联的方法。此外，还可以调用便利方法 <code>getFields()</code>、<code>getMethods()</code>、<code>getConstructors()</code> 等，以返回表示字段、方法和构造函数的对象数组。（你可以通过在 JDK 文档中查找类 <code>Class</code> 来了解更多信息。）因此，匿名对象的类信息可以在运行时完全确定，编译时不需要知道任何信息。</p>
<p>重要的是要意识到反射没有什么魔力。当你使用反射与未知类型的对象交互时，JVM 将查看该对象，并看到它属于特定的类（就像普通的 RTTI）。在对其执行任何操作之前，必须加载 <code>Class</code> 对象。因此，该特定类型的 <code>.class</code> 文件必须在本地计算机上或通过网络对 JVM 仍然可用。因此，RTTI 和反射的真正区别在于，使用 RTTI 时，编译器在编译时会打开并检查 <code>.class</code> 文件。换句话说，你可以用“正常”的方式调用一个对象的所有方法。通过反射，<code>.class</code> 文件在编译时不可用；它由运行时环境打开并检查。</p>
<h3 id="类方法提取器"><a href="#类方法提取器" class="headerlink" title="类方法提取器"></a>类方法提取器</h3><p>通常，你不会直接使用反射工具，但它们可以帮助你创建更多的动态代码。反射是用来支持其他 Java 特性的，例如对象序列化（参见<a href="https://lingcoder.github.io/OnJava8/#/book/Appendix-Object-Serialization" target="_blank" rel="noopener">附录：对象序列化</a>）。但是，有时动态提取有关类的信息很有用。</p>
<p>考虑一个类方法提取器。查看类定义的源代码或 JDK 文档，只显示<em>在该类定义中</em>定义或重写的方法。但是，可能还有几十个来自基类的可用方法。找到它们既单调又费时[^1]。幸运的是，反射提供了一种方法，可以简单地编写一个工具类自动地向你展示所有的接口：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// typeinfo/ShowMethods.java</span></span><br><span class="line"><span class="comment">// 使用反射展示一个类的所有方法，甚至包括定义在基类中方法</span></span><br><span class="line"><span class="comment">// &#123;java ShowMethods ShowMethods&#125;</span></span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.*;</span><br><span class="line"><span class="keyword">import</span> java.util.regex.*;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ShowMethods</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> String usage =</span><br><span class="line">            <span class="string">"usage:\n"</span> +</span><br><span class="line">            <span class="string">"ShowMethods qualified.class.name\n"</span> +</span><br><span class="line">            <span class="string">"To show all methods in class or:\n"</span> +</span><br><span class="line">            <span class="string">"ShowMethods qualified.class.name word\n"</span> +</span><br><span class="line">            <span class="string">"To search for methods involving 'word'"</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> Pattern p = Pattern.compile(<span class="string">"\\w+\\."</span>);</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (args.length &lt; <span class="number">1</span>) &#123;</span><br><span class="line">            System.out.println(usage);</span><br><span class="line">            System.exit(<span class="number">0</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">int</span> lines = <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            Class&lt;?&gt; c = Class.forName(args[<span class="number">0</span>]);</span><br><span class="line">            Method[] methods = c.getMethods();</span><br><span class="line">            Constructor[] ctors = c.getConstructors();</span><br><span class="line">            <span class="keyword">if</span> (args.length == <span class="number">1</span>) &#123;</span><br><span class="line">                <span class="keyword">for</span> (Method method : methods)</span><br><span class="line">                    System.out.println(</span><br><span class="line">                            p.matcher(</span><br><span class="line">                                    method.toString()).replaceAll(<span class="string">""</span>));</span><br><span class="line">                <span class="keyword">for</span> (Constructor ctor : ctors)</span><br><span class="line">                    System.out.println(</span><br><span class="line">                            p.matcher(ctor.toString()).replaceAll(<span class="string">""</span>));</span><br><span class="line">                lines = methods.length + ctors.length;</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="keyword">for</span> (Method method : methods)</span><br><span class="line">                    <span class="keyword">if</span> (method.toString().contains(args[<span class="number">1</span>])) &#123;</span><br><span class="line">                        System.out.println(p.matcher(</span><br><span class="line">                                method.toString()).replaceAll(<span class="string">""</span>));</span><br><span class="line">                        lines++;</span><br><span class="line">                    &#125;</span><br><span class="line">                <span class="keyword">for</span> (Constructor ctor : ctors)</span><br><span class="line">                    <span class="keyword">if</span> (ctor.toString().contains(args[<span class="number">1</span>])) &#123;</span><br><span class="line">                        System.out.println(p.matcher(</span><br><span class="line">                                ctor.toString()).replaceAll(<span class="string">""</span>));</span><br><span class="line">                        lines++;</span><br><span class="line">                    &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (ClassNotFoundException e) &#123;</span><br><span class="line">            System.out.println(<span class="string">"No such class: "</span> + e);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>输出结果：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">public static void main(String[])</span><br><span class="line">public final void wait() throws InterruptedException</span><br><span class="line">public final void wait(long,int) throws</span><br><span class="line">InterruptedException</span><br><span class="line">public final native void wait(long) throws</span><br><span class="line">InterruptedException</span><br><span class="line">public boolean equals(Object)</span><br><span class="line">public String toString()</span><br><span class="line">public native int hashCode()</span><br><span class="line">public final native Class getClass()</span><br><span class="line">public final native void notify()</span><br><span class="line">public final native void notifyAll()</span><br><span class="line">public ShowMethods()</span><br></pre></td></tr></table></figure>
<p><code>Class</code> 方法 <code>getmethods()</code> 和 <code>getconstructors()</code>  分别返回 <code>Method</code> 数组和 <code>Constructor</code> 数组。这些类中的每一个都有进一步的方法来解析它们所表示的方法的名称、参数和返回值。但你也可以像这里所做的那样，使用 <code>toString()</code>，生成带有整个方法签名的 <code>String</code>。代码的其余部分提取命令行信息，确定特定签名是否与目标 <code>String</code>（使用 <code>indexOf()</code>）匹配，并使用正则表达式（在 <a href="#ch021.xhtml#strings">Strings</a> 一章中介绍）删除名称限定符。</p>
<p>编译时无法知道 <code>Class.forName()</code> 生成的结果，因此所有方法签名信息都是在运行时提取的。如果你研究 JDK 反射文档，你将看到有足够的支持来实际设置和对编译时完全未知的对象进行方法调用（本书后面有这样的例子）。虽然最初你可能认为你永远都不需要这样做，但是反射的全部价值可能会令人惊讶。</p>
<p>上面的输出来自命令行：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">java ShowMethods ShowMethods</span><br></pre></td></tr></table></figure>
<p>输出包含一个 <code>public</code> 无参数构造函数，即使未定义构造函数。你看到的构造函数是由编译器自动合成的。如果将 <code>ShowMethods</code> 设置为非 <code>public</code> 类（即只有包级访问权），则合成的无参数构造函数将不再显示在输出中。自动为合成的无参数构造函数授予与类相同的访问权。</p>
<p>尝试运行 <code>java ShowMethods java.lang.String</code>，并附加一个 <code>char</code>、<code>int</code>、<code>String</code> 等参数。</p>
<p>编程时，当你不记得某个类是否有特定的方法，并且不想在 JDK 文档中搜索索引或类层次结构时，或者如果你不知道该类是否可以对 <code>Color</code> 对象执行任何操作时，该工具能节省不少时间。</p>
<!-- Dynamic Proxies -->
<h2 id="动态代理"><a href="#动态代理" class="headerlink" title="动态代理"></a>动态代理</h2><p><em>代理</em>是基本的设计模式之一。一个对象封装真实对象，代替其提供其他或不同的操作—这些操作通常涉及到与“真实”对象的通信，因此代理通常充当中间对象。这是一个简单的示例，显示代理的结构：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// typeinfo/SimpleProxyDemo.java</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">interface</span> <span class="title">Interface</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">doSomething</span><span class="params">()</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">somethingElse</span><span class="params">(String arg)</span></span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">RealObject</span> <span class="keyword">implements</span> <span class="title">Interface</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">doSomething</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        System.out.println(<span class="string">"doSomething"</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">somethingElse</span><span class="params">(String arg)</span> </span>&#123;</span><br><span class="line">        System.out.println(<span class="string">"somethingElse "</span> + arg);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">SimpleProxy</span> <span class="keyword">implements</span> <span class="title">Interface</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> Interface proxied;</span><br><span class="line"></span><br><span class="line">    SimpleProxy(Interface proxied) &#123;</span><br><span class="line">        <span class="keyword">this</span>.proxied = proxied;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">doSomething</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        System.out.println(<span class="string">"SimpleProxy doSomething"</span>);</span><br><span class="line">        proxied.doSomething();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">somethingElse</span><span class="params">(String arg)</span> </span>&#123;</span><br><span class="line">        System.out.println(</span><br><span class="line">                <span class="string">"SimpleProxy somethingElse "</span> + arg);</span><br><span class="line">        proxied.somethingElse(arg);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">SimpleProxyDemo</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">consumer</span><span class="params">(Interface iface)</span> </span>&#123;</span><br><span class="line">        iface.doSomething();</span><br><span class="line">        iface.somethingElse(<span class="string">"bonobo"</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        consumer(<span class="keyword">new</span> RealObject());</span><br><span class="line">        consumer(<span class="keyword">new</span> SimpleProxy(<span class="keyword">new</span> RealObject()));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>输出结果：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">doSomething</span><br><span class="line">somethingElse bonobo</span><br><span class="line">SimpleProxy doSomething</span><br><span class="line">doSomething</span><br><span class="line">SimpleProxy somethingElse bonobo</span><br><span class="line">somethingElse bonobo</span><br></pre></td></tr></table></figure>
<p>因为 <code>consumer()</code> 接受 <code>Interface</code>，所以它不知道获得的是 <code>RealObject</code> 还是 <code>SimpleProxy</code>，因为两者都实现了 <code>Interface</code>。<br>但是，在客户端和 <code>RealObject</code> 之间插入的 <code>SimpleProxy</code> 执行操作，然后在 <code>RealObject</code> 上调用相同的方法。</p>
<p>当你希望将额外的操作与“真实对象”做分离时，代理可能会有所帮助，尤其是当你想要轻松地启用额外的操作时，反之亦然（设计模式就是封装变更—所以你必须改变一些东西以证明模式的合理性）。例如，如果你想跟踪对 <code>RealObject</code> 中方法的调用，或衡量此类调用的开销，该怎么办？你不想这部分代码耦合到你的程序中，而代理能使你可以很轻松地添加或删除它。</p>
<p>Java 的<em>动态代理</em>更进一步，不仅动态创建代理对象而且动态处理对代理方法的调用。在动态代理上进行的所有调用都被重定向到单个<em>调用处理程序</em>，该处理程序负责发现调用的内容并决定如何处理。这是 <code>SimpleProxyDemo.java</code> 使用动态代理重写的例子：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// typeinfo/SimpleDynamicProxy.java</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.*;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">DynamicProxyHandler</span> <span class="keyword">implements</span> <span class="title">InvocationHandler</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> Object proxied;</span><br><span class="line"></span><br><span class="line">    DynamicProxyHandler(Object proxied) &#123;</span><br><span class="line">        <span class="keyword">this</span>.proxied = proxied;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> Object</span><br><span class="line">    invoke(Object proxy, Method method, Object[] args)</span><br><span class="line">            <span class="keyword">throws</span> Throwable &#123;</span><br><span class="line">        System.out.println(</span><br><span class="line">                <span class="string">"**** proxy: "</span> + proxy.getClass() +</span><br><span class="line">                        <span class="string">", method: "</span> + method + <span class="string">", args: "</span> + args);</span><br><span class="line">        <span class="keyword">if</span> (args != <span class="keyword">null</span>)</span><br><span class="line">            <span class="keyword">for</span> (Object arg : args)</span><br><span class="line">                System.out.println(<span class="string">"  "</span> + arg);</span><br><span class="line">        <span class="keyword">return</span> method.invoke(proxied, args);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">SimpleDynamicProxy</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">consumer</span><span class="params">(Interface iface)</span> </span>&#123;</span><br><span class="line">        iface.doSomething();</span><br><span class="line">        iface.somethingElse(<span class="string">"bonobo"</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        RealObject real = <span class="keyword">new</span> RealObject();</span><br><span class="line">        consumer(real);</span><br><span class="line">        <span class="comment">// Insert a proxy and call again:</span></span><br><span class="line">        Interface proxy = (Interface) Proxy.newProxyInstance(</span><br><span class="line">                Interface.class.getClassLoader(),</span><br><span class="line">                <span class="keyword">new</span> Class[]&#123;Interface.class&#125;,</span><br><span class="line">                <span class="keyword">new</span> DynamicProxyHandler(real));</span><br><span class="line">        consumer(proxy);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>输出结果：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">doSomething</span><br><span class="line">somethingElse bonobo</span><br><span class="line">**** proxy: class $Proxy0, method: public abstract void</span><br><span class="line">Interface.doSomething(), args: null</span><br><span class="line">doSomething</span><br><span class="line">**** proxy: class $Proxy0, method: public abstract void</span><br><span class="line">Interface.somethingElse(java.lang.String), args:</span><br><span class="line">[Ljava.lang.Object;@6bc7c054</span><br><span class="line">  bonobo</span><br><span class="line">somethingElse bonobo</span><br></pre></td></tr></table></figure>
<p>可以通过调用静态方法 <code>Proxy.newProxyInstance()</code> 来创建动态代理，该方法需要一个类加载器（通常可以从已加载的对象中获取），希望代理实现的接口列表（不是类或抽象类），以及接口  <code>InvocationHandler</code> 的一个实现。动态代理会将所有调用重定向到调用处理程序，因此通常为调用处理程序的构造函数提供对“真实”对象的引用，以便一旦执行中介任务便可以转发请求。</p>
<p><code>invoke()</code> 方法被传递给代理对象，以防万一你必须区分请求的来源—但是在很多情况下都无需关心。但是，在 <code>invoke()</code> 内的代理上调用方法时要小心，因为接口的调用是通过代理重定向的。</p>
<p>通常执行代理操作，然后使用 <code>Method.invoke()</code> 将请求转发给被代理对象，并携带必要的参数。这在一开始看起来是有限制的，好像你只能执行一般的操作。但是，可以过滤某些方法调用，同时传递其他方法调用：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// typeinfo/SelectingMethods.java</span></span><br><span class="line"><span class="comment">// Looking for particular methods in a dynamic proxy</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.*;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">MethodSelector</span> <span class="keyword">implements</span> <span class="title">InvocationHandler</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> Object proxied;</span><br><span class="line"></span><br><span class="line">    MethodSelector(Object proxied) &#123;</span><br><span class="line">        <span class="keyword">this</span>.proxied = proxied;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> Object</span><br><span class="line">    invoke(Object proxy, Method method, Object[] args)</span><br><span class="line">            <span class="keyword">throws</span> Throwable &#123;</span><br><span class="line">        <span class="keyword">if</span> (method.getName().equals(<span class="string">"interesting"</span>))</span><br><span class="line">            System.out.println(</span><br><span class="line">                    <span class="string">"Proxy detected the interesting method"</span>);</span><br><span class="line">        <span class="keyword">return</span> method.invoke(proxied, args);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">interface</span> <span class="title">SomeMethods</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">boring1</span><span class="params">()</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">boring2</span><span class="params">()</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">interesting</span><span class="params">(String arg)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">boring3</span><span class="params">()</span></span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Implementation</span> <span class="keyword">implements</span> <span class="title">SomeMethods</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">boring1</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        System.out.println(<span class="string">"boring1"</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">boring2</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        System.out.println(<span class="string">"boring2"</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">interesting</span><span class="params">(String arg)</span> </span>&#123;</span><br><span class="line">        System.out.println(<span class="string">"interesting "</span> + arg);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">boring3</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        System.out.println(<span class="string">"boring3"</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">SelectingMethods</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        SomeMethods proxy =</span><br><span class="line">                (SomeMethods) Proxy.newProxyInstance(</span><br><span class="line">                        SomeMethods.class.getClassLoader(),</span><br><span class="line">                        <span class="keyword">new</span> Class[]&#123; SomeMethods.class &#125;,</span><br><span class="line">                        <span class="keyword">new</span> MethodSelector(<span class="keyword">new</span> Implementation()));</span><br><span class="line">        proxy.boring1();</span><br><span class="line">        proxy.boring2();</span><br><span class="line">        proxy.interesting(<span class="string">"bonobo"</span>);</span><br><span class="line">        proxy.boring3();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>输出结果：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">boring1</span><br><span class="line">boring2</span><br><span class="line">Proxy detected the interesting method</span><br><span class="line">interesting bonobo</span><br><span class="line">boring3</span><br></pre></td></tr></table></figure>
<p>在这个示例里，我们只是在寻找方法名，但是你也可以寻找方法签名的其他方面，甚至可以搜索特定的参数值。</p>
<p>动态代理不是你每天都会使用的工具，但是它可以很好地解决某些类型的问题。你可以在 Erich Gamma 等人的<em>设计模式</em>中了解有关<em>代理</em>和其他设计模式的更多信息。 （Addison-Wesley，1995年），以及<a href="./25-Patterns.md">设计模式</a>一章。</p>
<!-- Using Optional -->
<h2 id="Optional类"><a href="#Optional类" class="headerlink" title="Optional类"></a>Optional类</h2><p>如果你使用内置的 <code>null</code> 来表示没有对象，每次使用引用的时候就必须测试一下引用是否为 <code>null</code>，这显得有点枯燥，而且势必会产生相当乏味的代码。问题在于 <code>null</code> 没什么自己的行为，只会在你想用它执行任何操作的时候产生 <code>NullPointException</code>。<code>java.util.Optional</code>（首次出现是在<a href="docs/book/13-Functional-Programming.md">函数式编程</a>这章）为 <code>null</code> 值提供了一个轻量级代理，<code>Optional</code> 对象可以防止你的代码直接抛出 <code>NullPointException</code>。</p>
<p>虽然 <code>Optional</code> 是 Java 8 为了支持流式编程才引入的，但其实它是一个通用的工具。为了证明这点，在本节中，我们会把它用在普通的类中。因为涉及一些运行时检测，所以把这一小节放在了本章。</p>
<p>实际上，在所有地方都使用 <code>Optional</code> 是没有意义的，有时候检查一下是不是 <code>null</code> 也挺好的，或者有时我们可以合理地假设不会出现 <code>null</code>，甚至有时候检查 <code>NullPointException</code> 异常也是可以接受的。<code>Optional</code> 最有用武之地的是在那些“更接近数据”的地方，在问题空间中代表实体的对象上。举个简单的例子，很多系统中都有 <code>Person</code> 类型，代码中有些情况下你可能没有一个实际的 <code>Person</code> 对象（或者可能有，但是你还没用关于那个人的所有信息）。这时，在传统方法下，你会用到一个 <code>null</code> 引用，并且在使用的时候测试它是不是 <code>null</code>。而现在，我们可以使用 <code>Optional</code>：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// typeinfo/Person.java</span></span><br><span class="line"><span class="comment">// Using Optional with regular classes</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> onjava.*;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.*;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Person</span> </span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">final</span> Optional&lt;String&gt; first;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">final</span> Optional&lt;String&gt; last;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">final</span> Optional&lt;String&gt; address;</span><br><span class="line">    <span class="comment">// etc.</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">final</span> Boolean empty;</span><br><span class="line"></span><br><span class="line">    Person(String first, String last, String address) &#123;</span><br><span class="line">        <span class="keyword">this</span>.first = Optional.ofNullable(first);</span><br><span class="line">        <span class="keyword">this</span>.last = Optional.ofNullable(last);</span><br><span class="line">        <span class="keyword">this</span>.address = Optional.ofNullable(address);</span><br><span class="line">        empty = !<span class="keyword">this</span>.first.isPresent()</span><br><span class="line">                &amp;&amp; !<span class="keyword">this</span>.last.isPresent()</span><br><span class="line">                &amp;&amp; !<span class="keyword">this</span>.address.isPresent();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    Person(String first, String last) &#123;</span><br><span class="line">        <span class="keyword">this</span>(first, last, <span class="keyword">null</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    Person(String last) &#123;</span><br><span class="line">        <span class="keyword">this</span>(<span class="keyword">null</span>, last, <span class="keyword">null</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    Person() &#123;</span><br><span class="line">        <span class="keyword">this</span>(<span class="keyword">null</span>, <span class="keyword">null</span>, <span class="keyword">null</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">toString</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (empty)</span><br><span class="line">            <span class="keyword">return</span> <span class="string">"&lt;Empty&gt;"</span>;</span><br><span class="line">        <span class="keyword">return</span> (first.orElse(<span class="string">""</span>) +</span><br><span class="line">                <span class="string">" "</span> + last.orElse(<span class="string">""</span>) +</span><br><span class="line">                <span class="string">" "</span> + address.orElse(<span class="string">""</span>)).trim();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        System.out.println(<span class="keyword">new</span> Person());</span><br><span class="line">        System.out.println(<span class="keyword">new</span> Person(<span class="string">"Smith"</span>));</span><br><span class="line">        System.out.println(<span class="keyword">new</span> Person(<span class="string">"Bob"</span>, <span class="string">"Smith"</span>));</span><br><span class="line">        System.out.println(<span class="keyword">new</span> Person(<span class="string">"Bob"</span>, <span class="string">"Smith"</span>,</span><br><span class="line">                <span class="string">"11 Degree Lane, Frostbite Falls, MN"</span>));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>输出结果：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">&lt;Empty&gt;</span><br><span class="line">Smith</span><br><span class="line">Bob Smith</span><br><span class="line">Bob Smith 11 Degree Lane, Frostbite Falls, MN</span><br></pre></td></tr></table></figure>
<p><code>Person</code> 的设计有时候又叫“数据传输对象（DTO，data-transfer object）”。注意，所有字段都是 <code>public</code> 和 <code>final</code> 的，所以没有 <code>getter</code> 和 <code>setter</code> 方法。也就是说，<code>Person</code> 是不可变的，你只能通过构造器给它赋值，之后就只能读而不能修改它的值（字符串本身就是不可变的，因此你无法修改字符串的内容，也无法给它的字段重新赋值）。如果你想修改一个 <code>Person</code>，你只能用一个新的 <code>Person</code> 对象来替换它。<code>empty</code> 字段在对象创建的时候被赋值，用于快速判断这个 <code>Person</code> 对象是不是空对象。</p>
<p>如果想使用 <code>Person</code>，就必须使用 <code>Optional</code> 接口才能访问它的 <code>String</code> 字段，这样就不会意外触发 <code>NullPointException</code> 了。</p>
<p>现在假设你已经因你惊人的理念而获得了一大笔风险投资，现在你要招兵买马了，但是在虚位以待时，你可以将 <code>Person Optional</code> 对象放在每个 <code>Position</code> 上：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// typeinfo/Position.java</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.*;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">EmptyTitleException</span> <span class="keyword">extends</span> <span class="title">RuntimeException</span> </span>&#123;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Position</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> String title;</span><br><span class="line">    <span class="keyword">private</span> Person person;</span><br><span class="line"></span><br><span class="line">    Position(String jobTitle, Person employee) &#123;</span><br><span class="line">        setTitle(jobTitle);</span><br><span class="line">        setPerson(employee);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    Position(String jobTitle) &#123;</span><br><span class="line">        <span class="keyword">this</span>(jobTitle, <span class="keyword">null</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getTitle</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> title;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setTitle</span><span class="params">(String newTitle)</span> </span>&#123;</span><br><span class="line">        <span class="comment">// Throws EmptyTitleException if newTitle is null:</span></span><br><span class="line">        title = Optional.ofNullable(newTitle)</span><br><span class="line">                .orElseThrow(EmptyTitleException::<span class="keyword">new</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Person <span class="title">getPerson</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> person;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setPerson</span><span class="params">(Person newPerson)</span> </span>&#123;</span><br><span class="line">        <span class="comment">// Uses empty Person if newPerson is null:</span></span><br><span class="line">        person = Optional.ofNullable(newPerson)</span><br><span class="line">                .orElse(<span class="keyword">new</span> Person());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">toString</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">"Position: "</span> + title +</span><br><span class="line">                <span class="string">", Employee: "</span> + person;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        System.out.println(<span class="keyword">new</span> Position(<span class="string">"CEO"</span>));</span><br><span class="line">        System.out.println(<span class="keyword">new</span> Position(<span class="string">"Programmer"</span>,</span><br><span class="line">                <span class="keyword">new</span> Person(<span class="string">"Arthur"</span>, <span class="string">"Fonzarelli"</span>)));</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">new</span> Position(<span class="keyword">null</span>);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            System.out.println(<span class="string">"caught "</span> + e);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>输出结果：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">Position: CEO, Employee: &lt;Empty&gt;</span><br><span class="line">Position: Programmer, Employee: Arthur Fonzarelli</span><br><span class="line">caught EmptyTitleException</span><br></pre></td></tr></table></figure>
<p>这里使用 <code>Optional</code> 的方式不太一样。请注意，<code>title</code> 和 <code>person</code> 都是普通字段，不受 <code>Optional</code> 的保护。但是，修改这些字段的唯一途径是调用 <code>setTitle()</code> 和 <code>setPerson()</code> 方法，这两个都借助 <code>Optional</code> 对字段进行了严格的限制。</p>
<p>同时，我们想保证 <code>title</code> 字段永远不会变成 <code>null</code> 值。为此，我们可以自己在 <code>setTitle()</code> 方法里边检查参数 <code>newTitle</code> 的值。但其实还有更好的做法，函数式编程一大优势就是可以让我们重用经过验证的功能（即便是个很小的功能），以减少自己手动编写代码可能产生的一些小错误。所以在这里，我们用 <code>ofNullable()</code> 把 <code>newTitle</code> 转换一个 <code>Optional</code>（如果传入的值为 <code>null</code>，<code>ofNullable()</code> 返回的将是 <code>Optional.empty()</code>）。紧接着我们调用了 <code>orElseThrow()</code> 方法，所以如果 <code>newTitle</code> 的值是 <code>null</code>，你将会得到一个异常。这里我们并没有把 <code>title</code> 保存成 <code>Optional</code>，但通过应用 <code>Optional</code> 的功能，我们仍然如愿以偿地对这个字段施加了约束。</p>
<p><code>EmptyTitleException</code> 是一个 <code>RuntimeException</code>，因为它意味着程序存在错误。在这个方案里边，你仍然可能会得到一个异常。但不同的是，在错误产生的那一刻（向 <code>setTitle()</code> 传 <code>null</code> 值时）就会抛出异常，而不是发生在其它时刻，需要你通过调试才能发现问题所在。另外，使用 <code>EmptyTitleException</code> 还有助于定位 BUG。</p>
<p><code>Person</code> 字段的限制又不太一样：如果你把它的值设为 <code>null</code>，程序会自动把将它赋值成一个空的 <code>Person</code> 对象。先前我们也用过类似的方法把字段转换成 <code>Option</code>，但这里我们是在返回结果的时候使用 <code>orElse(new Person())</code> 插入一个空的 <code>Person</code> 对象替代了 <code>null</code>。</p>
<p>在 <code>Position</code> 里边，我们没有创建一个表示“空”的标志位或者方法，因为 <code>person</code> 字段的 <code>Person</code> 对象为空，就表示这个 <code>Position</code> 是个空缺位置。之后，你可能会发现你必须添加一个显式的表示“空位”的方法，但是正如 YAGNI[^2] (You Aren’t Going to Need It，你永远不需要它)所言，在初稿时“实现尽最大可能的简单”，直到程序在某些方面要求你为其添加一些额外的特性，而不是假设这是必要的。</p>
<p>请注意，虽然你清楚你使用了 <code>Optional</code>，可以免受 <code>NullPointerExceptions</code> 的困扰，但是 <code>Staff</code> 类却对此毫不知情。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// typeinfo/Staff.java</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.*;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Staff</span> <span class="keyword">extends</span> <span class="title">ArrayList</span>&lt;<span class="title">Position</span>&gt; </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">add</span><span class="params">(String title, Person person)</span> </span>&#123;</span><br><span class="line">        add(<span class="keyword">new</span> Position(title, person));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">add</span><span class="params">(String... titles)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">for</span> (String title : titles)</span><br><span class="line">            add(<span class="keyword">new</span> Position(title));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">Staff</span><span class="params">(String... titles)</span> </span>&#123;</span><br><span class="line">        add(titles);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Boolean <span class="title">positionAvailable</span><span class="params">(String title)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">for</span> (Position position : <span class="keyword">this</span>)</span><br><span class="line">            <span class="keyword">if</span> (position.getTitle().equals(title) &amp;&amp;</span><br><span class="line">                    position.getPerson().empty)</span><br><span class="line">                <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">fillPosition</span><span class="params">(String title, Person hire)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">for</span> (Position position : <span class="keyword">this</span>)</span><br><span class="line">            <span class="keyword">if</span> (position.getTitle().equals(title) &amp;&amp;</span><br><span class="line">                    position.getPerson().empty) &#123;</span><br><span class="line">                position.setPerson(hire);</span><br><span class="line">                <span class="keyword">return</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(</span><br><span class="line">                <span class="string">"Position "</span> + title + <span class="string">" not available"</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        Staff staff = <span class="keyword">new</span> Staff(<span class="string">"President"</span>, <span class="string">"CTO"</span>,</span><br><span class="line">                <span class="string">"Marketing Manager"</span>, <span class="string">"Product Manager"</span>,</span><br><span class="line">                <span class="string">"Project Lead"</span>, <span class="string">"Software Engineer"</span>,</span><br><span class="line">                <span class="string">"Software Engineer"</span>, <span class="string">"Software Engineer"</span>,</span><br><span class="line">                <span class="string">"Software Engineer"</span>, <span class="string">"Test Engineer"</span>,</span><br><span class="line">                <span class="string">"Technical Writer"</span>);</span><br><span class="line">        staff.fillPosition(<span class="string">"President"</span>,</span><br><span class="line">                <span class="keyword">new</span> Person(<span class="string">"Me"</span>, <span class="string">"Last"</span>, <span class="string">"The Top, Lonely At"</span>));</span><br><span class="line">        staff.fillPosition(<span class="string">"Project Lead"</span>,</span><br><span class="line">                <span class="keyword">new</span> Person(<span class="string">"Janet"</span>, <span class="string">"Planner"</span>, <span class="string">"The Burbs"</span>));</span><br><span class="line">        <span class="keyword">if</span> (staff.positionAvailable(<span class="string">"Software Engineer"</span>))</span><br><span class="line">            staff.fillPosition(<span class="string">"Software Engineer"</span>,</span><br><span class="line">                    <span class="keyword">new</span> Person(</span><br><span class="line">                            <span class="string">"Bob"</span>, <span class="string">"Coder"</span>, <span class="string">"Bright Light City"</span>));</span><br><span class="line">        System.out.println(staff);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>输出结果：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">[Position: President, Employee: Me Last The Top, Lonely</span><br><span class="line">At, Position: CTO, Employee: &lt;Empty&gt;, Position:</span><br><span class="line">Marketing Manager, Employee: &lt;Empty&gt;, Position: Product</span><br><span class="line">Manager, Employee: &lt;Empty&gt;, Position: Project Lead,</span><br><span class="line">Employee: Janet Planner The Burbs, Position: Software</span><br><span class="line">Engineer, Employee: Bob Coder Bright Light City,</span><br><span class="line">Position: Software Engineer, Employee: &lt;Empty&gt;,</span><br><span class="line">Position: Software Engineer, Employee: &lt;Empty&gt;,</span><br><span class="line">Position: Software Engineer, Employee: &lt;Empty&gt;,</span><br><span class="line">Position: Test Engineer, Employee: &lt;Empty&gt;, Position:</span><br><span class="line">Technical Writer, Employee: &lt;Empty&gt;]</span><br></pre></td></tr></table></figure>
<p>注意，在有些地方你可能还是要测试引用是不是 <code>Optional</code>，这跟检查是否为 <code>null</code> 没什么不同。但是在其它地方（例如本例中的 <code>toString()</code> 转换），你就不必执行额外的测试了，而可以直接假设所有对象都是有效的。</p>
<h3 id="标记接口"><a href="#标记接口" class="headerlink" title="标记接口"></a>标记接口</h3><p>有时候使用一个<strong>标记接口</strong>来表示空值会更方便。标记接口里边什么都没有，你只要把它的名字当做标签来用就可以。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// onjava/Null.java</span></span><br><span class="line"><span class="keyword">package</span> onjava;</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">Null</span> </span>&#123;&#125;</span><br></pre></td></tr></table></figure>
<p>如果你用接口取代具体类，那么就可以使用 <code>DynamicProxy</code> 来自动地创建 <code>Null</code> 对象。假设我们有一个 <code>Robot</code> 接口，它定义了一个名字、一个模型和一个描述 <code>Robot</code> 行为能力的 <code>List&lt;Operation&gt;</code>：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// typeinfo/Robot.java</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> onjava.*;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.*;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">Robot</span> </span>&#123;</span><br><span class="line">    <span class="function">String <span class="title">name</span><span class="params">()</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="function">String <span class="title">model</span><span class="params">()</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="function">List&lt;Operation&gt; <span class="title">operations</span><span class="params">()</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">test</span><span class="params">(Robot r)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (r <span class="keyword">instanceof</span> Null)</span><br><span class="line">            System.out.println(<span class="string">"[Null Robot]"</span>);</span><br><span class="line">        System.out.println(<span class="string">"Robot name: "</span> + r.name());</span><br><span class="line">        System.out.println(<span class="string">"Robot model: "</span> + r.model());</span><br><span class="line">        <span class="keyword">for</span> (Operation operation : r.operations()) &#123;</span><br><span class="line">            System.out.println(operation.description.get());</span><br><span class="line">            operation.command.run();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>你可以通过调用 <code>operations()</code> 来访问 <code>Robot</code> 的服务。<code>Robot</code> 里边还有一个 <code>static</code> 方法来执行测试。</p>
<p><code>Operation</code> 包含一个描述和一个命令（这用到了<strong>命令模式</strong>）。它们被定义成函数式接口的引用，所以可以把 lambda 表达式或者方法的引用传给 <code>Operation</code> 的构造器：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// typeinfo/Operation.java</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.function.*;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Operation</span> </span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">final</span> Supplier&lt;String&gt; description;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">final</span> Runnable command;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">Operation</span><span class="params">(Supplier&lt;String&gt; descr, Runnable cmd)</span> </span>&#123;</span><br><span class="line">        description = descr;</span><br><span class="line">        command = cmd;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>现在我们可以创建一个扫雪 <code>Robot</code>：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// typeinfo/SnowRemovalRobot.java</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.*;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">SnowRemovalRobot</span> <span class="keyword">implements</span> <span class="title">Robot</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> String name;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">SnowRemovalRobot</span><span class="params">(String name)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.name = name;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">name</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> name;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">model</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">"SnowBot Series 11"</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> List&lt;Operation&gt; ops = Arrays.asList(</span><br><span class="line">            <span class="keyword">new</span> Operation(</span><br><span class="line">                    () -&gt; name + <span class="string">" can shovel snow"</span>,</span><br><span class="line">                    () -&gt; System.out.println(</span><br><span class="line">                            name + <span class="string">" shoveling snow"</span>)),</span><br><span class="line">            <span class="keyword">new</span> Operation(</span><br><span class="line">                    () -&gt; name + <span class="string">" can chip ice"</span>,</span><br><span class="line">                    () -&gt; System.out.println(name + <span class="string">" chipping ice"</span>)),</span><br><span class="line">            <span class="keyword">new</span> Operation(</span><br><span class="line">                    () -&gt; name + <span class="string">" can clear the roof"</span>,</span><br><span class="line">                    () -&gt; System.out.println(</span><br><span class="line">                            name + <span class="string">" clearing roof"</span>)));</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> List&lt;Operation&gt; <span class="title">operations</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> ops;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        Robot.test(<span class="keyword">new</span> SnowRemovalRobot(<span class="string">"Slusher"</span>));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>输出结果：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">Robot name: Slusher</span><br><span class="line">Robot model: SnowBot Series 11</span><br><span class="line">Slusher can shovel snow</span><br><span class="line">Slusher shoveling snow</span><br><span class="line">Slusher can chip ice</span><br><span class="line">Slusher chipping ice</span><br><span class="line">Slusher can clear the roof</span><br><span class="line">Slusher clearing roof</span><br></pre></td></tr></table></figure>
<p>假设存在许多不同类型的 <code>Robot</code>，我们想让每种 <code>Robot</code> 都创建一个 <code>Null</code> 对象来执行一些特殊的操作——在本例中，即提供 <code>Null</code> 对象所代表 <code>Robot</code> 的确切类型信息。这些信息是通过动态代理捕获的：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// typeinfo/NullRobot.java</span></span><br><span class="line"><span class="comment">// Using a dynamic proxy to create an Optional</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.*;</span><br><span class="line"><span class="keyword">import</span> java.util.*;</span><br><span class="line"><span class="keyword">import</span> java.util.stream.*;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> onjava.*;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">NullRobotProxyHandler</span></span></span><br><span class="line"><span class="class">        <span class="keyword">implements</span> <span class="title">InvocationHandler</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> String nullName;</span><br><span class="line">    <span class="keyword">private</span> Robot proxied = <span class="keyword">new</span> NRobot();</span><br><span class="line"></span><br><span class="line">    NullRobotProxyHandler(Class&lt;? extends Robot&gt; type) &#123;</span><br><span class="line">        nullName = type.getSimpleName() + <span class="string">" NullRobot"</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="class"><span class="keyword">class</span> <span class="title">NRobot</span> <span class="keyword">implements</span> <span class="title">Null</span>, <span class="title">Robot</span> </span>&#123;</span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> String <span class="title">name</span><span class="params">()</span> </span>&#123;</span><br><span class="line">            <span class="keyword">return</span> nullName;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> String <span class="title">model</span><span class="params">()</span> </span>&#123;</span><br><span class="line">            <span class="keyword">return</span> nullName;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> List&lt;Operation&gt; <span class="title">operations</span><span class="params">()</span> </span>&#123;</span><br><span class="line">            <span class="keyword">return</span> Collections.emptyList();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> Object</span><br><span class="line">    invoke(Object proxy, Method method, Object[] args)</span><br><span class="line">            <span class="keyword">throws</span> Throwable &#123;</span><br><span class="line">        <span class="keyword">return</span> method.invoke(proxied, args);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">NullRobot</span> </span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> Robot</span><br><span class="line">    newNullRobot(Class&lt;? extends Robot&gt; type) &#123;</span><br><span class="line">        <span class="keyword">return</span> (Robot) Proxy.newProxyInstance(</span><br><span class="line">                NullRobot.class.getClassLoader(),</span><br><span class="line">                <span class="keyword">new</span> Class[] &#123; Null.class, Robot.class &#125;,</span><br><span class="line">                <span class="keyword">new</span> NullRobotProxyHandler(type));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        Stream.of(</span><br><span class="line">                <span class="keyword">new</span> SnowRemovalRobot(<span class="string">"SnowBee"</span>),</span><br><span class="line">                newNullRobot(SnowRemovalRobot.class)</span><br><span class="line">        ).forEach(Robot::test);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>输出结果：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">Robot name: SnowBee</span><br><span class="line">Robot model: SnowBot Series 11</span><br><span class="line">SnowBee can shovel snow</span><br><span class="line">SnowBee shoveling snow</span><br><span class="line">SnowBee can chip ice</span><br><span class="line">SnowBee chipping ice</span><br><span class="line">SnowBee can clear the roof</span><br><span class="line">SnowBee clearing roof</span><br><span class="line">[Null Robot]</span><br><span class="line">Robot name: SnowRemovalRobot NullRobot</span><br><span class="line">Robot model: SnowRemovalRobot NullRobot</span><br></pre></td></tr></table></figure>
<p>无论何时，如果你需要一个空 <code>Robot</code> 对象，只需要调用 <code>newNullRobot()</code>，并传递需要代理的 <code>Robot</code> 的类型。这个代理满足了 <code>Robot</code> 和 <code>Null</code> 接口的需要，并提供了它所代理的类型的确切名字。</p>
<h3 id="Mock-对象和桩"><a href="#Mock-对象和桩" class="headerlink" title="Mock 对象和桩"></a>Mock 对象和桩</h3><p><strong>Mock 对象</strong>和 <strong>桩（Stub）</strong>在逻辑上都是 <code>Optional</code> 的变体。他们都是最终程序中所使用的“实际”对象的代理。不过，Mock 对象和桩都是假扮成那些可以传递实际信息的实际对象，而不是像 <code>Optional</code> 那样把包含潜在 <code>null</code> 值的对象隐藏。</p>
<p>Mock 对象和桩之间的的差别在于程度不同。Mock 对象往往是轻量级的，且用于自测试。通常，为了处理各种不同的测试场景，我们会创建出很多 Mock 对象。而桩只是返回桩数据，它通常是重量级的，并且经常在多个测试中被复用。桩可以根据它们被调用的方式，通过配置进行修改。因此，桩是一种复杂对象，它可以做很多事情。至于 Mock 对象，如果你要做很多事，通常会创建大量又小又简单的 Mock 对象。</p>
<!-- Interfaces and Type -->
<h2 id="接口和类型"><a href="#接口和类型" class="headerlink" title="接口和类型"></a>接口和类型</h2><p><code>interface</code> 关键字的一个重要目标就是允许程序员隔离组件，进而降低耦合度。使用接口可以实现这一目标，但是通过类型信息，这种耦合性还是会传播出去——接口并不是对解耦的一种无懈可击的保障。比如我们先写一个接口：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// typeinfo/interfacea/A.java</span></span><br><span class="line"><span class="keyword">package</span> typeinfo.interfacea;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">A</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">f</span><span class="params">()</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>然后实现这个接口，你可以看到其代码是怎么从实际类型开始顺藤摸瓜的：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// typeinfo/InterfaceViolation.java</span></span><br><span class="line"><span class="comment">// Sneaking around an interface</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> typeinfo.interfacea.*;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">B</span> <span class="keyword">implements</span> <span class="title">A</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">f</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">g</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">InterfaceViolation</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        A a = <span class="keyword">new</span> B();</span><br><span class="line">        a.f();</span><br><span class="line">        <span class="comment">// a.g(); // Compile error</span></span><br><span class="line">        System.out.println(a.getClass().getName());</span><br><span class="line">        <span class="keyword">if</span> (a <span class="keyword">instanceof</span> B) &#123;</span><br><span class="line">            B b = (B) a;</span><br><span class="line">            b.g();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>输出结果：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">B</span><br></pre></td></tr></table></figure>
<p>通过使用 RTTI，我们发现 <code>a</code> 是用 <code>B</code> 实现的。通过将其转型为 <code>B</code>，我们可以调用不在 <code>A</code> 中的方法。</p>
<p>这样的操作完全是合情合理的，但是你也许并不想让客户端开发者这么做，因为这给了他们一个机会，使得他们的代码与你的代码的耦合度超过了你的预期。也就是说，你可能认为 <code>interface</code> 关键字正在保护你，但其实并没有。另外，在本例中使用 <code>B</code> 来实现 <code>A</code> 这种情况是有公开案例可查的[^3]。</p>
<p>一种解决方案是直接声明，如果开发者决定使用实际的类而不是接口，他们需要自己对自己负责。这在很多情况下都是可行的，但“可能”还不够，你或许希望能有一些更严格的控制方式。</p>
<p>最简单的方式是让实现类只具有包访问权限，这样在包外部的客户端就看不到它了：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// typeinfo/packageaccess/HiddenC.java</span></span><br><span class="line"><span class="keyword">package</span> typeinfo.packageaccess;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> typeinfo.interfacea.*;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">C</span> <span class="keyword">implements</span> <span class="title">A</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">f</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        System.out.println(<span class="string">"public C.f()"</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">g</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        System.out.println(<span class="string">"public C.g()"</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">u</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        System.out.println(<span class="string">"package C.u()"</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">v</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        System.out.println(<span class="string">"protected C.v()"</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">w</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        System.out.println(<span class="string">"private C.w()"</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">HiddenC</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> A <span class="title">makeA</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> C();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>在这个包中唯一 <code>public</code> 的部分就是 <code>HiddenC</code>，在被调用时将产生 <code>A</code>接口类型的对象。这里有趣之处在于：即使你从 <code>makeA()</code> 返回的是 <code>C</code> 类型，你在包的外部仍旧不能使用 <code>A</code> 之外的任何方法，因为你不能在包的外部命名 <code>C</code>。</p>
<p>现在如果你试着将其向下转型为 <code>C</code>，则将被禁止，因为在包的外部没有任何 <code>C</code> 类型可用：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// typeinfo/HiddenImplementation.java</span></span><br><span class="line"><span class="comment">// Sneaking around package hiding</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> typeinfo.interfacea.*;</span><br><span class="line"><span class="keyword">import</span> typeinfo.packageaccess.*;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.*;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">HiddenImplementation</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        A a = HiddenC.makeA();</span><br><span class="line">        a.f();</span><br><span class="line">        System.out.println(a.getClass().getName());</span><br><span class="line">        <span class="comment">// Compile error: cannot find symbol 'C':</span></span><br><span class="line">        <span class="comment">/* if(a instanceof C) &#123;</span></span><br><span class="line"><span class="comment">            C c = (C)a;</span></span><br><span class="line"><span class="comment">            c.g();</span></span><br><span class="line"><span class="comment">        &#125; */</span></span><br><span class="line">        <span class="comment">// Oops! Reflection still allows us to call g():</span></span><br><span class="line">        callHiddenMethod(a, <span class="string">"g"</span>);</span><br><span class="line">        <span class="comment">// And even less accessible methods!</span></span><br><span class="line">        callHiddenMethod(a, <span class="string">"u"</span>);</span><br><span class="line">        callHiddenMethod(a, <span class="string">"v"</span>);</span><br><span class="line">        callHiddenMethod(a, <span class="string">"w"</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">callHiddenMethod</span><span class="params">(Object a, String methodName)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        Method g = a.getClass().getDeclaredMethod(methodName);</span><br><span class="line">        g.setAccessible(<span class="keyword">true</span>);</span><br><span class="line">        g.invoke(a);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>输出结果：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">public C.f()</span><br><span class="line">typeinfo.packageaccess.C</span><br><span class="line">public C.g()</span><br><span class="line">package C.u()</span><br><span class="line">protected C.v()</span><br><span class="line">private C.w()</span><br></pre></td></tr></table></figure>
<p>正如你所看到的，通过使用反射，仍然可以调用所有方法，甚至是 <code>private</code> 方法！如果知道方法名，你就可以在其 <code>Method</code> 对象上调用 <code>setAccessible(true)</code>，就像在 <code>callHiddenMethod()</code> 中看到的那样。</p>
<p>你可能觉得，可以通过只发布编译后的代码来阻止这种情况，但其实这并不能解决问题。因为只需要运行 <code>javap</code>（一个随 JDK 发布的反编译器）即可突破这一限制。下面是一个使用 <code>javap</code> 的命令行：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">javap -private C</span><br></pre></td></tr></table></figure>
<p><code>-private</code> 标志表示所有的成员都应该显示，甚至包括私有成员。下面是输出：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">class typeinfo.packageaccess.C extends</span><br><span class="line">java.lang.Object implements typeinfo.interfacea.A &#123;</span><br><span class="line">  typeinfo.packageaccess.C();</span><br><span class="line">  public void f();</span><br><span class="line">  public void g();</span><br><span class="line">  void u();</span><br><span class="line">  protected void v();</span><br><span class="line">  private void w();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>因此，任何人都可以获取你最私有的方法的名字和签名，然后调用它们。</p>
<p>那如果把接口实现为一个私有内部类，又会怎么样呢？下面展示了这种情况：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// typeinfo/InnerImplementation.java</span></span><br><span class="line"><span class="comment">// Private inner classes can't hide from reflection</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> typeinfo.interfacea.*;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">InnerA</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">C</span> <span class="keyword">implements</span> <span class="title">A</span> </span>&#123;</span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">f</span><span class="params">()</span> </span>&#123;</span><br><span class="line">            System.out.println(<span class="string">"public C.f()"</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">g</span><span class="params">()</span> </span>&#123;</span><br><span class="line">            System.out.println(<span class="string">"public C.g()"</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">void</span> <span class="title">u</span><span class="params">()</span> </span>&#123;</span><br><span class="line">            System.out.println(<span class="string">"package C.u()"</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">v</span><span class="params">()</span> </span>&#123;</span><br><span class="line">            System.out.println(<span class="string">"protected C.v()"</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">w</span><span class="params">()</span> </span>&#123;</span><br><span class="line">            System.out.println(<span class="string">"private C.w()"</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> A <span class="title">makeA</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> C();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">InnerImplementation</span> </span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span></span><br><span class="line">    main(String[] args) <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        A a = InnerA.makeA();</span><br><span class="line">        a.f();</span><br><span class="line">        System.out.println(a.getClass().getName());</span><br><span class="line">        <span class="comment">// Reflection still gets into the private class:</span></span><br><span class="line">        HiddenImplementation.callHiddenMethod(a, <span class="string">"g"</span>);</span><br><span class="line">        HiddenImplementation.callHiddenMethod(a, <span class="string">"u"</span>);</span><br><span class="line">        HiddenImplementation.callHiddenMethod(a, <span class="string">"v"</span>);</span><br><span class="line">        HiddenImplementation.callHiddenMethod(a, <span class="string">"w"</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>输出结果：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">public C.f()</span><br><span class="line">InnerA$C</span><br><span class="line">public C.g()</span><br><span class="line">package C.u()</span><br><span class="line">protected C.v()</span><br><span class="line">private C.w()</span><br></pre></td></tr></table></figure>
<p>这里对反射仍然没有任何东西可以隐藏。那么如果是匿名类呢？</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// typeinfo/AnonymousImplementation.java</span></span><br><span class="line"><span class="comment">// Anonymous inner classes can't hide from reflection</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> typeinfo.interfacea.*;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">AnonymousA</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> A <span class="title">makeA</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> A() &#123;</span><br><span class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">f</span><span class="params">()</span> </span>&#123;</span><br><span class="line">                System.out.println(<span class="string">"public C.f()"</span>);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">g</span><span class="params">()</span> </span>&#123;</span><br><span class="line">                System.out.println(<span class="string">"public C.g()"</span>);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="function"><span class="keyword">void</span> <span class="title">u</span><span class="params">()</span> </span>&#123;</span><br><span class="line">                System.out.println(<span class="string">"package C.u()"</span>);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">v</span><span class="params">()</span> </span>&#123;</span><br><span class="line">                System.out.println(<span class="string">"protected C.v()"</span>);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">w</span><span class="params">()</span> </span>&#123;</span><br><span class="line">                System.out.println(<span class="string">"private C.w()"</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">AnonymousImplementation</span> </span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span></span><br><span class="line">    main(String[] args) <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        A a = AnonymousA.makeA();</span><br><span class="line">        a.f();</span><br><span class="line">        System.out.println(a.getClass().getName());</span><br><span class="line">        <span class="comment">// Reflection still gets into the anonymous class:</span></span><br><span class="line">        HiddenImplementation.callHiddenMethod(a, <span class="string">"g"</span>);</span><br><span class="line">        HiddenImplementation.callHiddenMethod(a, <span class="string">"u"</span>);</span><br><span class="line">        HiddenImplementation.callHiddenMethod(a, <span class="string">"v"</span>);</span><br><span class="line">        HiddenImplementation.callHiddenMethod(a, <span class="string">"w"</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>输出结果：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">public C.f()</span><br><span class="line">AnonymousA$1</span><br><span class="line">public C.g()</span><br><span class="line">package C.u()</span><br><span class="line">protected C.v()</span><br><span class="line">private C.w()</span><br></pre></td></tr></table></figure>
<p>看起来任何方式都没法阻止反射调用那些非公共访问权限的方法。对于字段来说也是这样，即便是 <code>private</code> 字段：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// typeinfo/ModifyingPrivateFields.java</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.*;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">WithPrivateFinalField</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">int</span> i = <span class="number">1</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> String s = <span class="string">"I'm totally safe"</span>;</span><br><span class="line">    <span class="keyword">private</span> String s2 = <span class="string">"Am I safe?"</span>;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">toString</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">"i = "</span> + i + <span class="string">", "</span> + s + <span class="string">", "</span> + s2;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ModifyingPrivateFields</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        WithPrivateFinalField pf =</span><br><span class="line">                <span class="keyword">new</span> WithPrivateFinalField();</span><br><span class="line">        System.out.println(pf);</span><br><span class="line">        Field f = pf.getClass().getDeclaredField(<span class="string">"i"</span>);</span><br><span class="line">        f.setAccessible(<span class="keyword">true</span>);</span><br><span class="line">        System.out.println(</span><br><span class="line">                <span class="string">"f.getInt(pf): "</span> + f.getInt(pf));</span><br><span class="line">        f.setInt(pf, <span class="number">47</span>);</span><br><span class="line">        System.out.println(pf);</span><br><span class="line">        f = pf.getClass().getDeclaredField(<span class="string">"s"</span>);</span><br><span class="line">        f.setAccessible(<span class="keyword">true</span>);</span><br><span class="line">        System.out.println(<span class="string">"f.get(pf): "</span> + f.get(pf));</span><br><span class="line">        f.set(pf, <span class="string">"No, you're not!"</span>);</span><br><span class="line">        System.out.println(pf);</span><br><span class="line">        f = pf.getClass().getDeclaredField(<span class="string">"s2"</span>);</span><br><span class="line">        f.setAccessible(<span class="keyword">true</span>);</span><br><span class="line">        System.out.println(<span class="string">"f.get(pf): "</span> + f.get(pf));</span><br><span class="line">        f.set(pf, <span class="string">"No, you're not!"</span>);</span><br><span class="line">        System.out.println(pf);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>输出结果：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">i = 1, I&apos;m totally safe, Am I safe?</span><br><span class="line">f.getInt(pf): 1</span><br><span class="line">i = 47, I&apos;m totally safe, Am I safe?</span><br><span class="line">f.get(pf): I&apos;m totally safe</span><br><span class="line">i = 47, I&apos;m totally safe, Am I safe?</span><br><span class="line">f.get(pf): Am I safe?</span><br><span class="line">i = 47, I&apos;m totally safe, No, you&apos;re not!</span><br></pre></td></tr></table></figure>
<p>但实际上 <code>final</code> 字段在被修改时是安全的。运行时系统会在不抛出异常的情况下接受任何修改的尝试，但是实际上不会发生任何修改。</p>
<p>通常，所有这些违反访问权限的操作并不是什么十恶不赦的。如果有人使用这样的技术去调用标志为 <code>private</code> 或包访问权限的方法（很明显这些访问权限表示这些人不应该调用它们），那么对他们来说，如果你修改了这些方法的某些地方，他们不应该抱怨。另一方面，总是在类中留下后门，也许会帮助你解决某些特定类型的问题（这些问题往往除此之外，别无它法）。总之，不可否认，反射给我们带来了很多好处。</p>
<p>程序员往往对编程语言提供的访问控制过于自信，甚至认为 Java 在安全性上比其它提供了（明显）更宽松的访问控制的语言要优越[^4]。然而，正如你所看到的，事实并不是这样。</p>
<!-- Summary -->
<h2 id="本章小结"><a href="#本章小结" class="headerlink" title="本章小结"></a>本章小结</h2><p>RTTI 允许通过匿名类的引用来获取类型信息。初学者极易误用它，因为在学会使用多态调用方法之前，这么做也很有效。有过程化编程背景的人很容易把程序组织成一系列 <code>switch</code> 语句，你可以用 RTTI 和 <code>switch</code> 实现功能，但这样就损失了多态机制在代码开发和维护过程中的重要价值。面向对象编程语言是想让我们尽可能地使用多态机制，只在非用不可的时候才使用 RTTI。</p>
<p>然而使用多态机制的方法调用，要求我们拥有基类定义的控制权。因为在你扩展程序的时候，可能会发现基类并未包含我们想要的方法。如果基类来自别人的库，这时 RTTI 便是一种解决之道：可继承一个新类，然后添加你需要的方法。在代码的其它地方，可以检查你自己特定的类型，并调用你自己的方法。这样做不会破坏多态性以及程序的扩展能力，因为这样添加一个新的类并不需要修改程序中的 <code>switch</code> 语句。但如果想在程序中增加具有新特性的代码，你就必须使用 RTTI 来检查这个特定的类型。</p>
<p>如果只是为了方便某个特定的类，就将某个特性放进基类里边，这将使得从那个基类派生出的所有其它子类都带有这些可能毫无意义的东西。这会导致接口更加不清晰，因为我们必须覆盖从基类继承而来的所有抽象方法，事情就变得很麻烦。举个例子，现在有一个表示乐器 <code>Instrument</code> 的类层次结构。假设我们想清理管弦乐队中某些乐器残留的口水，一种办法是在基类 <code>Instrument</code> 中放入 <code>clearSpitValve()</code> 方法。但这样做会导致类结构混乱，因为这意味着打击乐器 <code>Percussion</code>、弦乐器 <code>Stringed</code> 和电子乐器 <code>Electronic</code> 也需要清理口水。在这个例子中，RTTI 可以提供一种更合理的解决方案。可以将 <code>clearSpitValve()</code> 放在某个合适的类中，在这个例子中是管乐器 <code>Wind</code>。不过，在这里你可能会发现还有更好的解决方法，就是将 <code>prepareInstrument()</code> 放在基类中，但是初次面对这个问题的读者可能想不到还有这样的解决方案，而误认为必须使用 RTTI。</p>
<p>最后一点，RTTI 有时候也能解决效率问题。假设你的代码运用了多态，但是为了实现多态，导致其中某个对象的效率非常低。这时候，你就可以挑出那个类，使用 RTTI 为它编写一段特别的代码以提高效率。然而必须注意的是，不要太早地关注程序的效率问题，这是个诱人的陷阱。最好先让程序能跑起来，然后再去看看程序能不能跑得更快，下一步才是去解决效率问题（比如使用 Profiler）[^5]。</p>
<p>我们已经看到，反射，因其更加动态的编程风格，为我们开创了编程的新世界。但对有些人来说，反射的动态特性却是一种困扰。对那些已经习惯于静态类型检查的安全性的人来说，Java 中允许这种动态类型检查（只在运行时才能检查到，并以异常的形式上报检查结果）的操作似乎是一种错误的方向。有些人想得更远，他们认为引入运行时异常本身就是一种指示，指示我们应该避免这种代码。我发现这种意义的安全是一种错觉，因为总是有些事情是在运行时才发生并抛出异常的，即使是在那些不包含任何 <code>try</code> 语句块或异常声明的程序中也是如此。因此，我认为一致性错误报告模型的存在使我们能够通过使用反射编写动态代码。当然，尽力编写能够进行静态检查的代码是有价值的，只要你有这样的能力。但是我相信动态代码是将 Java 与其它诸如 C++ 这样的语言区分开的重要工具之一。</p>
<p>[^1]: 特别是在过去。但现在 Java 的 HTML 文档有了很大的提升，要查看基类的方法已经变得很容易了。</p>
<p>[^2]: 这是极限编程（XP，Extreme Programming）的原则之一：“Try the simplest thing that could possibly work，实现尽最大可能的简单。”</p>
<p>[^3]: 最著名的例子是 Windows 操作系统，Windows 为开发者提供了公开的 API，但是开发者还可以找到一些非公开但是可以调用的函数。为了解决问题，很多程序员使用了隐藏的 API 函数。这就迫使微软公司要像维护公开 API 一样维护这些隐藏的 API，消耗了巨大的成本和精力。</p>
<p>[^4]: 比如，Python 中在元素前面添加双下划线 <code>__</code>，就表示你想隐藏这个元素。如果你在类或者包外面调用了这个元素，运行环境就会报错。</p>
<p>[^5]: 译者注：Java Profiler 是一种 Java 性能分析工具，用于在 JVM 级别监视 Java 字节码的构造和执行。主流的 Profiler 有 JProfiler、YourKit 和 Java VisualVM 等。</p>
<!-- 分页 -->
<div style="page-break-after: always;"></div>

      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      
      
      

      
        <div class="post-nav">
          <div class="post-nav-next post-nav-item">
            
              <a href="/2019/07/01/3/3_book/OnJava8/21-Arrays/" rel="next" title="第二十一章 数组">
                <i class="fa fa-chevron-left"></i> 第二十一章 数组
              </a>
            
          </div>

          <span class="post-nav-divider"></span>

          <div class="post-nav-prev post-nav-item">
            
              <a href="/2019/07/01/3/3_book/OnJava8/23-Annotations/" rel="prev" title="第二十三章 注解">
                第二十三章 注解 <i class="fa fa-chevron-right"></i>
              </a>
            
          </div>
        </div>
      

      
      
    </footer>
  </div>
  
  
  
  </article>



    <div class="post-spread">
      
    </div>
  </div>


          </div>
          


          
  <div class="comments" id="comments">
    
  </div>


        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    
    <div class="sidebar-inner">

      

      
        <ul class="sidebar-nav motion-element">
          <li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap">
            文章目录
          </li>
          <li class="sidebar-nav-overview" data-target="site-overview">
            站点概览
          </li>
        </ul>
      

      <section class="site-overview sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
          <img class="site-author-image" itemprop="image" src="/images/avatar.gif" alt="kay wu">
          <p class="site-author-name" itemprop="name">kay wu</p>
           
              <p class="site-description motion-element" itemprop="description">给时间以生命，而不是给生命以时间</p>
          
        </div>
        <nav class="site-state motion-element">

          
            <div class="site-state-item site-state-posts">
              <a href="/archives/">
                <span class="site-state-item-count">151</span>
                <span class="site-state-item-name">日志</span>
              </a>
            </div>
          

          
            
            
            <div class="site-state-item site-state-categories">
              <a href="/categories/index.html">
                <span class="site-state-item-count">6</span>
                <span class="site-state-item-name">分类</span>
              </a>
            </div>
          

          
            
            
            <div class="site-state-item site-state-tags">
              <a href="/tags/index.html">
                <span class="site-state-item-count">6</span>
                <span class="site-state-item-name">标签</span>
              </a>
            </div>
          

        </nav>

        

        <div class="links-of-author motion-element">
          
            
              <span class="links-of-author-item">
                <a href="https://github.com/Minato262" target="_blank" title="Github">
                  
                    <i class="fa fa-fw fa-globe"></i>
                  
                    
                      Github
                    
                </a>
              </span>
            
          
        </div>

        
        

        
        

        


      </section>

      
      <!--noindex-->
        <section class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active">
          <div class="post-toc">

            
              
            

            
              <div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#第十九章-类型信息"><span class="nav-text">第十九章 类型信息</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#为什么需要-RTTI"><span class="nav-text">为什么需要 RTTI</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Class-对象"><span class="nav-text">Class 对象</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#类字面常量"><span class="nav-text">类字面常量</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#泛化的-Class-引用"><span class="nav-text">泛化的 Class 引用</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#cast-方法"><span class="nav-text">cast() 方法</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#类型转换检测"><span class="nav-text">类型转换检测</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#使用类字面量"><span class="nav-text">使用类字面量</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#一个动态-instanceof-函数"><span class="nav-text">一个动态 instanceof 函数</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#递归计数"><span class="nav-text">递归计数</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#注册工厂"><span class="nav-text">注册工厂</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#类的等价比较"><span class="nav-text">类的等价比较</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#反射：运行时类信息"><span class="nav-text">反射：运行时类信息</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#类方法提取器"><span class="nav-text">类方法提取器</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#动态代理"><span class="nav-text">动态代理</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Optional类"><span class="nav-text">Optional类</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#标记接口"><span class="nav-text">标记接口</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Mock-对象和桩"><span class="nav-text">Mock 对象和桩</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#接口和类型"><span class="nav-text">接口和类型</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#本章小结"><span class="nav-text">本章小结</span></a></li></ol></li></ol></div>
            

          </div>
        </section>
      <!--/noindex-->
      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">
  
  &copy; 
  <span itemprop="copyrightYear">2020</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">kay wu</span>
</div>


<div class="powered-by">
  由 <a class="theme-link" href="https://hexo.io">Hexo</a> 强力驱动
</div>

<div class="theme-info">
  主题 -
  <a class="theme-link" href="https://github.com/iissnan/hexo-theme-next">
    NexT.Pisces
  </a>
</div>


        

        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  












  
  <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>

  
  <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>

  
  <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>

  
  <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.2"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.2"></script>



  
  


  <script type="text/javascript" src="/js/src/affix.js?v=5.1.2"></script>

  <script type="text/javascript" src="/js/src/schemes/pisces.js?v=5.1.2"></script>



  
  <script type="text/javascript" src="/js/src/scrollspy.js?v=5.1.2"></script>
<script type="text/javascript" src="/js/src/post-details.js?v=5.1.2"></script>



  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.2"></script>



  


  




	





  





  






  

  <script type="text/javascript">
    // Popup Window;
    var isfetched = false;
    var isXml = true;
    // Search DB path;
    var search_path = "search.xml";
    if (search_path.length === 0) {
      search_path = "search.xml";
    } else if (/json$/i.test(search_path)) {
      isXml = false;
    }
    var path = "/" + search_path;
    // monitor main search box;

    var onPopupClose = function (e) {
      $('.popup').hide();
      $('#local-search-input').val('');
      $('.search-result-list').remove();
      $('#no-result').remove();
      $(".local-search-pop-overlay").remove();
      $('body').css('overflow', '');
    }

    function proceedsearch() {
      $("body")
        .append('<div class="search-popup-overlay local-search-pop-overlay"></div>')
        .css('overflow', 'hidden');
      $('.search-popup-overlay').click(onPopupClose);
      $('.popup').toggle();
      var $localSearchInput = $('#local-search-input');
      $localSearchInput.attr("autocapitalize", "none");
      $localSearchInput.attr("autocorrect", "off");
      $localSearchInput.focus();
    }

    // search function;
    var searchFunc = function(path, search_id, content_id) {
      'use strict';

      // start loading animation
      $("body")
        .append('<div class="search-popup-overlay local-search-pop-overlay">' +
          '<div id="search-loading-icon">' +
          '<i class="fa fa-spinner fa-pulse fa-5x fa-fw"></i>' +
          '</div>' +
          '</div>')
        .css('overflow', 'hidden');
      $("#search-loading-icon").css('margin', '20% auto 0 auto').css('text-align', 'center');

      $.ajax({
        url: path,
        dataType: isXml ? "xml" : "json",
        async: true,
        success: function(res) {
          // get the contents from search data
          isfetched = true;
          $('.popup').detach().appendTo('.header-inner');
          var datas = isXml ? $("entry", res).map(function() {
            return {
              title: $("title", this).text(),
              content: $("content",this).text(),
              url: $("url" , this).text()
            };
          }).get() : res;
          var input = document.getElementById(search_id);
          var resultContent = document.getElementById(content_id);
          var inputEventFunction = function() {
            var searchText = input.value.trim().toLowerCase();
            var keywords = searchText.split(/[\s\-]+/);
            if (keywords.length > 1) {
              keywords.push(searchText);
            }
            var resultItems = [];
            if (searchText.length > 0) {
              // perform local searching
              datas.forEach(function(data) {
                var isMatch = false;
                var hitCount = 0;
                var searchTextCount = 0;
                var title = data.title.trim();
                var titleInLowerCase = title.toLowerCase();
                var content = data.content.trim().replace(/<[^>]+>/g,"");
                var contentInLowerCase = content.toLowerCase();
                var articleUrl = decodeURIComponent(data.url);
                var indexOfTitle = [];
                var indexOfContent = [];
                // only match articles with not empty titles
                if(title != '') {
                  keywords.forEach(function(keyword) {
                    function getIndexByWord(word, text, caseSensitive) {
                      var wordLen = word.length;
                      if (wordLen === 0) {
                        return [];
                      }
                      var startPosition = 0, position = [], index = [];
                      if (!caseSensitive) {
                        text = text.toLowerCase();
                        word = word.toLowerCase();
                      }
                      while ((position = text.indexOf(word, startPosition)) > -1) {
                        index.push({position: position, word: word});
                        startPosition = position + wordLen;
                      }
                      return index;
                    }

                    indexOfTitle = indexOfTitle.concat(getIndexByWord(keyword, titleInLowerCase, false));
                    indexOfContent = indexOfContent.concat(getIndexByWord(keyword, contentInLowerCase, false));
                  });
                  if (indexOfTitle.length > 0 || indexOfContent.length > 0) {
                    isMatch = true;
                    hitCount = indexOfTitle.length + indexOfContent.length;
                  }
                }

                // show search results

                if (isMatch) {
                  // sort index by position of keyword

                  [indexOfTitle, indexOfContent].forEach(function (index) {
                    index.sort(function (itemLeft, itemRight) {
                      if (itemRight.position !== itemLeft.position) {
                        return itemRight.position - itemLeft.position;
                      } else {
                        return itemLeft.word.length - itemRight.word.length;
                      }
                    });
                  });

                  // merge hits into slices

                  function mergeIntoSlice(text, start, end, index) {
                    var item = index[index.length - 1];
                    var position = item.position;
                    var word = item.word;
                    var hits = [];
                    var searchTextCountInSlice = 0;
                    while (position + word.length <= end && index.length != 0) {
                      if (word === searchText) {
                        searchTextCountInSlice++;
                      }
                      hits.push({position: position, length: word.length});
                      var wordEnd = position + word.length;

                      // move to next position of hit

                      index.pop();
                      while (index.length != 0) {
                        item = index[index.length - 1];
                        position = item.position;
                        word = item.word;
                        if (wordEnd > position) {
                          index.pop();
                        } else {
                          break;
                        }
                      }
                    }
                    searchTextCount += searchTextCountInSlice;
                    return {
                      hits: hits,
                      start: start,
                      end: end,
                      searchTextCount: searchTextCountInSlice
                    };
                  }

                  var slicesOfTitle = [];
                  if (indexOfTitle.length != 0) {
                    slicesOfTitle.push(mergeIntoSlice(title, 0, title.length, indexOfTitle));
                  }

                  var slicesOfContent = [];
                  while (indexOfContent.length != 0) {
                    var item = indexOfContent[indexOfContent.length - 1];
                    var position = item.position;
                    var word = item.word;
                    // cut out 100 characters
                    var start = position - 20;
                    var end = position + 80;
                    if(start < 0){
                      start = 0;
                    }
                    if (end < position + word.length) {
                      end = position + word.length;
                    }
                    if(end > content.length){
                      end = content.length;
                    }
                    slicesOfContent.push(mergeIntoSlice(content, start, end, indexOfContent));
                  }

                  // sort slices in content by search text's count and hits' count

                  slicesOfContent.sort(function (sliceLeft, sliceRight) {
                    if (sliceLeft.searchTextCount !== sliceRight.searchTextCount) {
                      return sliceRight.searchTextCount - sliceLeft.searchTextCount;
                    } else if (sliceLeft.hits.length !== sliceRight.hits.length) {
                      return sliceRight.hits.length - sliceLeft.hits.length;
                    } else {
                      return sliceLeft.start - sliceRight.start;
                    }
                  });

                  // select top N slices in content

                  var upperBound = parseInt('1');
                  if (upperBound >= 0) {
                    slicesOfContent = slicesOfContent.slice(0, upperBound);
                  }

                  // highlight title and content

                  function highlightKeyword(text, slice) {
                    var result = '';
                    var prevEnd = slice.start;
                    slice.hits.forEach(function (hit) {
                      result += text.substring(prevEnd, hit.position);
                      var end = hit.position + hit.length;
                      result += '<b class="search-keyword">' + text.substring(hit.position, end) + '</b>';
                      prevEnd = end;
                    });
                    result += text.substring(prevEnd, slice.end);
                    return result;
                  }

                  var resultItem = '';

                  if (slicesOfTitle.length != 0) {
                    resultItem += "<li><a href='" + articleUrl + "' class='search-result-title'>" + highlightKeyword(title, slicesOfTitle[0]) + "</a>";
                  } else {
                    resultItem += "<li><a href='" + articleUrl + "' class='search-result-title'>" + title + "</a>";
                  }

                  slicesOfContent.forEach(function (slice) {
                    resultItem += "<a href='" + articleUrl + "'>" +
                      "<p class=\"search-result\">" + highlightKeyword(content, slice) +
                      "...</p>" + "</a>";
                  });

                  resultItem += "</li>";
                  resultItems.push({
                    item: resultItem,
                    searchTextCount: searchTextCount,
                    hitCount: hitCount,
                    id: resultItems.length
                  });
                }
              })
            };
            if (keywords.length === 1 && keywords[0] === "") {
              resultContent.innerHTML = '<div id="no-result"><i class="fa fa-search fa-5x" /></div>'
            } else if (resultItems.length === 0) {
              resultContent.innerHTML = '<div id="no-result"><i class="fa fa-frown-o fa-5x" /></div>'
            } else {
              resultItems.sort(function (resultLeft, resultRight) {
                if (resultLeft.searchTextCount !== resultRight.searchTextCount) {
                  return resultRight.searchTextCount - resultLeft.searchTextCount;
                } else if (resultLeft.hitCount !== resultRight.hitCount) {
                  return resultRight.hitCount - resultLeft.hitCount;
                } else {
                  return resultRight.id - resultLeft.id;
                }
              });
              var searchResultList = '<ul class=\"search-result-list\">';
              resultItems.forEach(function (result) {
                searchResultList += result.item;
              })
              searchResultList += "</ul>";
              resultContent.innerHTML = searchResultList;
            }
          }

          if ('auto' === 'auto') {
            input.addEventListener('input', inputEventFunction);
          } else {
            $('.search-icon').click(inputEventFunction);
            input.addEventListener('keypress', function (event) {
              if (event.keyCode === 13) {
                inputEventFunction();
              }
            });
          }

          // remove loading animation
          $(".local-search-pop-overlay").remove();
          $('body').css('overflow', '');

          proceedsearch();
        }
      });
    }

    // handle and trigger popup window;
    $('.popup-trigger').click(function(e) {
      e.stopPropagation();
      if (isfetched === false) {
        searchFunc(path, 'local-search-input', 'local-search-result');
      } else {
        proceedsearch();
      };
    });

    $('.popup-btn-close').click(onPopupClose);
    $('.popup').click(function(e){
      e.stopPropagation();
    });
    $(document).on('keyup', function (event) {
      var shouldDismissSearchPopup = event.which === 27 &&
        $('.search-popup').is(':visible');
      if (shouldDismissSearchPopup) {
        onPopupClose();
      }
    });
  </script>





  

  

  

  

  

  

</body>
</html>
